Testcase                                                                                                                 Result
--------                                                                                                                 ------
[8] pamfaillock_lock                                                                                                      PASS 
--- begin output -----------------------------------------------------------
rotate_audit_logs: Attempting to rotate using USR1
+ source tp_ssh_functions.bash
++ source functions.bash
+++ [[ -z 1 ]]
+++ return 0
++ BFOLDER=/tmp
++ RND=11280
++ TIMEOUT=600
+ /sbin/faillock --user testuser --reset
++ id -u testuser
+ tuid=1004
+ grep -q pam_faillock /etc/pam.d/sshd
+ grep -q pam_faillock /etc/pam.d/password-auth
+ disable_ssh_strong_rng
+ MPROFILE=/etc/profile
+ SSHDCONF=/etc/sysconfig/sshd
+ CCCONF=/etc/profile.d/cc-configuration.sh
+ '[' -e /etc/profile ']'
+ backup /etc/profile
+ declare f b
+ for f in '"$@"'
++ mktemp /etc/profile.XXXXXX
+ b=/etc/profile.R4ha4G
+ cp -a /etc/profile /etc/profile.R4ha4G
+ prepend_cleanup 'mv -f '\''/etc/profile.R4ha4G'\'' '\''/etc/profile'\'''
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	mv -f '\''/etc/profile.R4ha4G'\'' '\''/etc/profile'\''
	    rm -f "$tmp1" "$tmp2" "$localtmp"
    }'
+ '[' -e /etc/sysconfig/sshd ']'
+ backup /etc/sysconfig/sshd
+ declare f b
+ for f in '"$@"'
++ mktemp /etc/sysconfig/sshd.XXXXXX
+ b=/etc/sysconfig/sshd.NH1bpi
+ cp -a /etc/sysconfig/sshd /etc/sysconfig/sshd.NH1bpi
+ prepend_cleanup 'mv -f '\''/etc/sysconfig/sshd.NH1bpi'\'' '\''/etc/sysconfig/sshd'\'''
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	mv -f '\''/etc/sysconfig/sshd.NH1bpi'\'' '\''/etc/sysconfig/sshd'\''
	    mv -f '\''/etc/profile.R4ha4G'\'' '\''/etc/profile'\'';
    rm -f "$tmp1" "$tmp2" "$localtmp"
    }'
+ '[' -e /etc/profile.d/cc-configuration.sh ']'
+ ssh_remove_screen /etc/profile
+ '[' x/etc/profile = x ']'
+ '[' -f /etc/profile ']'
+ sed -i 's/.*sleep [0-9]\+.*//g; s/.*exec.*SCREENEXEC.*//g' /etc/profile
+ ssh_restart_daemon
+ '[' capp = lspp ']'
+ service sshd restart
Redirecting to /bin/systemctl restart sshd.service
+ ssh_remove_strong_rng_env
+ export -n SSH_USE_STRONG_RNG
+ prepend_cleanup 'export SSH_USE_STRONG_RNG=12; readonly SSH_USE_STRONG_RNG'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	export SSH_USE_STRONG_RNG=12; readonly SSH_USE_STRONG_RNG
	    mv -f '\''/etc/sysconfig/sshd.NH1bpi'\'' '\''/etc/sysconfig/sshd'\'';
    mv -f '\''/etc/profile.R4ha4G'\'' '\''/etc/profile'\'';
    rm -f "$tmp1" "$tmp2" "$localtmp"
    }'
+ ssh_remove_strong_rng /etc/sysconfig/sshd
+ '[' x/etc/sysconfig/sshd = x ']'
+ '[' -f /etc/sysconfig/sshd ']'
+ sed -i 's/.*SSH_USE_STRONG_RNG.*//g' /etc/sysconfig/sshd
+ ssh_remove_strong_rng /etc/profile.d/cc-configuration.sh
+ '[' x/etc/profile.d/cc-configuration.sh = x ']'
+ '[' -f /etc/profile.d/cc-configuration.sh ']'
+ return
+ ssh_restart_daemon
+ '[' capp = lspp ']'
+ service sshd restart
Redirecting to /bin/systemctl restart sshd.service
+ expect -c '
    spawn ssh $env(TEST_USER)@localhost
    expect {
        {continue} { send "yes\r"; exp_continue }
    {assword} { send "badpassword\r" }
    }
    expect {
        {denied} { exp_continue }
        {assword} { send "badpassword\r" }
    }
    expect {
        {denied} { exp_continue }
        {assword} { send "badpassword\r" }
    }
    expect -nocase {denied} { close; wait }'
spawn ssh testuser@localhost
testuser@localhost's password: 
Permission denied, please try again.
testuser@localhost's password: 
Permission denied, please try again.
testuser@localhost's password: 
Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).
+ msg_1='pam_faillock uid=1004.*exe=./usr/sbin/sshd.*res=success.*'
+ augrok -q type=ANOM_LOGIN_FAILURES 'msg_1=~pam_faillock uid=1004.*exe=./usr/sbin/sshd.*res=success.*'
+ augrok -q type=RESP_ACCT_LOCK 'msg_1=~pam_faillock uid=1004.*exe=./usr/sbin/sshd.*res=success.*'
+ /sbin/faillock --user testuser --reset
+ exit_pass
+ [[ -n '' ]]
+ exit 0
+ test_cleanup
+ export SSH_USE_STRONG_RNG=12
+ SSH_USE_STRONG_RNG=12
+ readonly SSH_USE_STRONG_RNG
+ mv -f /etc/sysconfig/sshd.NH1bpi /etc/sysconfig/sshd
+ mv -f /etc/profile.R4ha4G /etc/profile
+ rm -f /tmp/tmp.najbxJxZnr /tmp/tmp.ePjHUhnolA /usr/local/eal4_testing/audit-test/tmp.xa6ZMhJ2IU
+ exit
--- end output -------------------------------------------------------------

