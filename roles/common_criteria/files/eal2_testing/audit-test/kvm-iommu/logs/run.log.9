Testcase                                                                                                                                                            Result
--------                                                                                                                                                            ------
[9] pci_passthrough dynamic_attach_on_boot                                                                                                                           FAIL 
        Failed to start guest with assigned PCI
--- begin output -----------------------------------------------------------
rotate_audit_logs: Attempting to rotate using USR1
+ source testcase.bash
++ source functions.bash
+++ [[ -z '' ]]
+++ _FUNCTIONS_BASH=1
+++ shopt -s extglob
+++ unset auditd_conf audit_log
+++ auditd_conf=/etc/audit/auditd.conf
+++ audit_log=/var/log/audit/audit.log
+++ unset zero
+++ zero=test_pci_passthrough.bash
+++ [[ capp == lspp ]]
++ [[ -n '' ]]
+++ mktemp -p /usr/local/eal4_testing/audit-test
++ localtmp=/usr/local/eal4_testing/audit-test/tmp.mzs28xfMbC
+++ mktemp
++ tmp1=/tmp/tmp.GRgikky0At
+++ mktemp
++ tmp2=/tmp/tmp.mkCZYkgVmp
++ trap 'test_cleanup; exit' 0 1 2 15
+ source pci_device.conf
++ pci_device=0000:03:00.0
+ source tp_luks_functions.bash
++ '[' -z ']'
+++ losetup -f
++ LOOPDEV=/dev/loop0
++ TIMEOUT=120
+ PCI_DEFCON=sysfs_t
+ scenario=dynamic_attach_on_boot
+ pkg_list='qemu-kvm libvirt libvirt-client'
+ pkg_list=bash
++ lspci -vvv -s 0000:03:00.0
++ sed -ne 's/Region.*Memory at \([a-f0-9]\{8\}\) .*/-e \1/p'
+ pci_regions='	-e f8000000'
+ [[ 0000:03:00.0 == *X* ]]
++ echo 0000:03:00.0
++ tr :. _
+ pci_device_name=pci_0000_03_00_0
++ echo 0000:03:00.0
++ cut -d: -f1
+ pci_domain=0000
++ echo 0000:03:00.0
++ cut -d: -f2
+ pci_bus=03
++ echo 0000:03:00.0
++ cut -d: -f3
++ sed 's/\..*//'
+ pci_slot=00
++ echo 0000:03:00.0
++ cut -d. -f2
+ pci_function=0
+ dom1=guest1
+ dom2=guest2
+ dom3=guest1-dynamic
+ dom4=guest2-dynamic
+ img_path=/var/lib/libvirt/images
++ cat /proc/sys/crypto/fips_enabled
+ FIPS=0
+ '[' x0 = x1 ']'
+ '[' -z dynamic_attach_on_boot ']'
+ set_selinux_booleans
+ /usr/sbin/getsebool virt_use_sysfs
+ grep off
Error getting active value for virt_use_sysfs
+ /usr/sbin/setsebool virt_use_sysfs 1
Could not change active booleans: Invalid boolean
+ reload_kvm_module_for_unsafe_interrupts
+ ./evirsh --readonly list
+ grep running
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
+ /sbin/modprobe -r kvm_intel
+ /sbin/modprobe -r kvm
+ /sbin/modprobe kvm allow_unsafe_assigned_interrupts=1
modprobe: ERROR: could not insert 'kvm': Unknown symbol in module, or unknown parameter (see dmesg)
+ /sbin/modprobe kvm_intel
+ check_kernel_boot_cmdline
+ /bin/grep intel_iommu=on /proc/cmdline
BOOT_IMAGE=/rhvh-4.3.10.1-0.20200513.0+1/vmlinuz-3.10.0-1127.8.2.el7.x86_64 root=/dev/rhvh/rhvh-4.3.10.1-0.20200513.0+1 ro crashkernel=auto rd.lvm.lv=rhvh/swap rhgb quiet intel_iommu=on rd.lvm.lv=rhvh/rhvh-4.3.10.1-0.20200513.0+1 img.bootid=rhvh-4.3.10.1-0.20200513.0+1
+ return 0
+ check_enabled_iommu
+ /bin/dmesg
+ /bin/grep 'IOMMU.*enabled'
[    0.000000] DMAR: IOMMU enabled
+ return 0
+ check_virt_extensions
+ /bin/grep vmx /proc/cpuinfo
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
+ return 0
+ check_selinux_booleans
+ return 0
+ check_kvm_modules
+ /sbin/lsmod
+ /bin/grep kvm_intel
kvm_intel             188688  0 
kvm                   636965  1 kvm_intel
+ return 0
+ check_installed_packages bash
+ /bin/rpm -q bash
bash-4.2.46-34.el7.x86_64
+ return 0
+ prepare_guest_domains
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00182132 s, 576 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00177427 s, 591 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00178549 s, 587 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.0019904 s, 527 MB/s
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c50,c70 /var/lib/libvirt/images/guest1.img
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c19,c83 /var/lib/libvirt/images/guest2.img
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp"
	/bin/rm -f /var/lib/libvirt/images/guest1.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img
	/bin/rm -f /var/lib/libvirt/images/guest2.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img
	/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
	/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
    }'
+ generate_pci_dev_file
+ /bin/cat
+ detach_multifunction_devices
++ echo pci_0000:03:00.0
++ tr :. _
+ pcifunction=pci_0000_03_00_0
++ echo pci_0000_03_00_0
++ sed 's/_[0-9]\+$//g'
+ pcidevice=pci_0000_03_00
++ ./evirsh nodedev-list
++ grep -c pci_0000_03_00
+ '[' 1 -gt 1 ']'
+ sestatus
+ grep mls
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
    }'
++ type -t test_dynamic_attach_on_boot
+ '[' function == function ']'
+ test_dynamic_attach_on_boot
+ start_guest_with_pci_device guest1-dynamic
+ local rc=0
+ create_guest_domain guest1-dynamic pci_dev.xml
+ '[' '!' -z pci_dev.xml ']'
+ /bin/sed '/HOSTDEV_CONFIG/ {r pci_dev.xml
        d}' guest1-dynamic-template.xml
+ append_cleanup '/bin/rm -f guest1-dynamic.xml'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
	/bin/rm -f guest1-dynamic.xml
    }'
+ prepend_cleanup './evirsh destroy guest1-dynamic'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	./evirsh destroy guest1-dynamic
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1-dynamic.xml
    }'
+ append_cleanup './evirsh nodedev-reattach pci_0000_03_00_0'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    ./evirsh destroy guest1-dynamic;
    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1-dynamic.xml
	./evirsh nodedev-reattach pci_0000_03_00_0
    }'
+ ./evirsh create guest1-dynamic.xml
spawn virsh create guest1-dynamic.xml
Please enter your authentication name: eal
Please enter your password: 
error: Failed to create domain from guest1-dynamic.xml
error: unsupported configuration: host doesn't support passthrough of host PCI devices

+ return 0
+ check_device_driver pci-stub
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 == x ']'
++ basename ../../../../../bus/pci/drivers/bnx2
+ test bnx2 == pci-stub
+ return 1
+ (( rc+=2 ))
++ get_guest_domain_pid guest1-dynamic
++ ./evirsh --readonly list
++ grep guest1-dynamic
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
++ return
+ pid_maps=
+ check_proc_pid_maps
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 = x ']'
+ grep -e f8000000 /proc//maps
grep: /proc//maps: No such file or directory
+ return 2
+ (( rc+=4 ))
+ return 6
+ exit_fail 'Failed to start guest with assigned PCI'
+ [[ -n Failed to start guest with assigned PCI ]]
+ printf '\nexit_fail: %s\n' 'Failed to start guest with assigned PCI'

exit_fail: Failed to start guest with assigned PCI
+ exit 1
+ test_cleanup
+ ./evirsh destroy guest1-dynamic
spawn virsh destroy guest1-dynamic
Please enter your authentication name: eal
Please enter your password: 
error: failed to get domain 'guest1-dynamic'
error: Domain not found: no domain with matching name 'guest1-dynamic'

+ rm -f /tmp/tmp.GRgikky0At /tmp/tmp.mkCZYkgVmp /usr/local/eal4_testing/audit-test/tmp.mzs28xfMbC
+ /bin/rm -f /var/lib/libvirt/images/guest1.img
+ /bin/rm -f /var/lib/libvirt/images/guest2.img
+ /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
+ /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource /sys/bus/pci/devices/0000:03:00.0/resource0
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
restorecon:  lstat(/sys/bus/pci/devices/0000:03:00.0/rom) failed:  No such file or directory
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
+ /bin/rm -f guest1-dynamic.xml
+ ./evirsh nodedev-reattach pci_0000_03_00_0
spawn virsh nodedev-reattach pci_0000_03_00_0
Please enter your authentication name: eal
Please enter your password: 
Device pci_0000_03_00_0 re-attached

+ exit

augrok output
-------------
Argument "enabled 1\nfailure 1\npid 943\nrate_limit 0\nbacklog_lim..." isn't numeric in numeric eq (==) at /usr/local/eal4_testing/audit-test/utils/augrok line 1209.
type=VIRT_MACHINE_ID msg=audit(1623663301.074:542): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1-dynamic" uuid=cf1a6351-52aa-4862-8b61-4cc47aa516af vm-ctx=system_u:system_r:svirt_t:s0:c499,c756 img-ctx=system_u:object_r:svirt_image_t:s0:c499,c756 model=selinux exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_MACHINE_ID msg=audit(1623663301.074:543): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1-dynamic" uuid=cf1a6351-52aa-4862-8b61-4cc47aa516af vm-ctx=+107:+107 img-ctx=+107:+107 model=dac exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663301.852:544): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=disk reason=start vm="guest1-dynamic" uuid=cf1a6351-52aa-4862-8b61-4cc47aa516af old-disk="?" new-disk="/var/lib/libvirt/images/guest1-dynamic.img" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663301.852:545): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=dev reason=start vm="guest1-dynamic" uuid=cf1a6351-52aa-4862-8b61-4cc47aa516af bus=pci device="0000:03:00.0" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663301.852:546): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=mem reason=start vm="guest1-dynamic" uuid=cf1a6351-52aa-4862-8b61-4cc47aa516af old-mem=0 new-mem=262144 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663301.852:547): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=vcpu reason=start vm="guest1-dynamic" uuid=cf1a6351-52aa-4862-8b61-4cc47aa516af old-vcpu=0 new-vcpu=1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_CONTROL msg=audit(1623663301.852:548): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm op=start reason=booted vm="guest1-dynamic" uuid=cf1a6351-52aa-4862-8b61-4cc47aa516af vm-pid=-1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=failed'
--- end output -------------------------------------------------------------

