
Started:                         Mon Jun 14 11:50:18 CEST 2021
Kernel:                          3.10.0-1127.8.2.el7.x86_64
Architecture:                    x86_64
Mode:                            64
Hostname:                        rhv.atsec.com
Profile:                         capp
selinux-policy version:          selinux-policy-3.13.1-266.el7.noarch

SELinux status:                 enabled
SELinuxfs mount:                /sys/fs/selinux
SELinux root directory:         /etc/selinux
Loaded policy name:             targeted
Current mode:                   enforcing
Mode from config file:          enforcing
Policy MLS status:              enabled
Policy deny_unknown status:     allowed
Max kernel policy version:      31

Log file started Mon Jun 14 11:50:18 CEST 2021
Adding group testuser
Adding user testuser
Adding group testadmin
Adding user testadmin
Testcase                                                                                                                                                            Result
--------                                                                                                                                                            ------
[0] pci_passthrough sanity_detach_1                                                                                                                                  FAIL 
        Failed to start guest with assigned PCI 0000:03:00.0
--- begin output -----------------------------------------------------------
rotate_audit_logs: Attempting to rotate using USR1
+ source testcase.bash
++ source functions.bash
+++ [[ -z '' ]]
+++ _FUNCTIONS_BASH=1
+++ shopt -s extglob
+++ unset auditd_conf audit_log
+++ auditd_conf=/etc/audit/auditd.conf
+++ audit_log=/var/log/audit/audit.log
+++ unset zero
+++ zero=test_pci_passthrough.bash
+++ [[ capp == lspp ]]
++ [[ -n '' ]]
+++ mktemp -p /usr/local/eal4_testing/audit-test
++ localtmp=/usr/local/eal4_testing/audit-test/tmp.GS1bgFGTKn
+++ mktemp
++ tmp1=/tmp/tmp.0c3U0Utfy7
+++ mktemp
++ tmp2=/tmp/tmp.KtyjrFSrOk
++ trap 'test_cleanup; exit' 0 1 2 15
+ source pci_device.conf
++ pci_device=0000:03:00.0
+ source tp_luks_functions.bash
++ '[' -z ']'
+++ losetup -f
++ LOOPDEV=/dev/loop0
++ TIMEOUT=120
+ PCI_DEFCON=sysfs_t
+ scenario=sanity_detach_1
+ pkg_list='qemu-kvm libvirt libvirt-client'
+ pkg_list=bash
++ lspci -vvv -s 0000:03:00.0
++ sed -ne 's/Region.*Memory at \([a-f0-9]\{8\}\) .*/-e \1/p'
+ pci_regions='	-e f8000000'
+ [[ 0000:03:00.0 == *X* ]]
++ echo 0000:03:00.0
++ tr :. _
+ pci_device_name=pci_0000_03_00_0
++ echo 0000:03:00.0
++ cut -d: -f1
+ pci_domain=0000
++ echo 0000:03:00.0
++ cut -d: -f2
+ pci_bus=03
++ echo 0000:03:00.0
++ cut -d: -f3
++ sed 's/\..*//'
+ pci_slot=00
++ echo 0000:03:00.0
++ cut -d. -f2
+ pci_function=0
+ dom1=guest1
+ dom2=guest2
+ dom3=guest1-dynamic
+ dom4=guest2-dynamic
+ img_path=/var/lib/libvirt/images
++ cat /proc/sys/crypto/fips_enabled
+ FIPS=0
+ '[' x0 = x1 ']'
+ '[' -z sanity_detach_1 ']'
+ set_selinux_booleans
+ /usr/sbin/getsebool virt_use_sysfs
+ grep off
Error getting active value for virt_use_sysfs
+ /usr/sbin/setsebool virt_use_sysfs 1
Could not change active booleans: Invalid boolean
+ reload_kvm_module_for_unsafe_interrupts
+ ./evirsh --readonly list
+ grep running
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
+ /sbin/modprobe -r kvm_intel
+ /sbin/modprobe -r kvm
+ /sbin/modprobe kvm allow_unsafe_assigned_interrupts=1
modprobe: ERROR: could not insert 'kvm': Unknown symbol in module, or unknown parameter (see dmesg)
+ /sbin/modprobe kvm_intel
+ check_kernel_boot_cmdline
+ /bin/grep intel_iommu=on /proc/cmdline
BOOT_IMAGE=/rhvh-4.3.10.1-0.20200513.0+1/vmlinuz-3.10.0-1127.8.2.el7.x86_64 root=/dev/rhvh/rhvh-4.3.10.1-0.20200513.0+1 ro crashkernel=auto rd.lvm.lv=rhvh/swap rhgb quiet intel_iommu=on rd.lvm.lv=rhvh/rhvh-4.3.10.1-0.20200513.0+1 img.bootid=rhvh-4.3.10.1-0.20200513.0+1
+ return 0
+ check_enabled_iommu
+ /bin/dmesg
+ /bin/grep 'IOMMU.*enabled'
[    0.000000] DMAR: IOMMU enabled
+ return 0
+ check_virt_extensions
+ /bin/grep vmx /proc/cpuinfo
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
+ return 0
+ check_selinux_booleans
+ return 0
+ check_kvm_modules
+ /sbin/lsmod
+ /bin/grep kvm_intel
kvm_intel             188688  0 
kvm                   636965  1 kvm_intel
+ return 0
+ check_installed_packages bash
+ /bin/rpm -q bash
bash-4.2.46-34.el7.x86_64
+ return 0
+ prepare_guest_domains
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00187718 s, 559 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00184122 s, 570 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00175444 s, 598 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00177872 s, 590 MB/s
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c50,c70 /var/lib/libvirt/images/guest1.img
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c19,c83 /var/lib/libvirt/images/guest2.img
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp"
	/bin/rm -f /var/lib/libvirt/images/guest1.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img
	/bin/rm -f /var/lib/libvirt/images/guest2.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img
	/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
	/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
    }'
+ generate_pci_dev_file
+ /bin/cat
+ detach_multifunction_devices
++ echo pci_0000:03:00.0
++ tr :. _
+ pcifunction=pci_0000_03_00_0
++ echo pci_0000_03_00_0
++ sed 's/_[0-9]\+$//g'
+ pcidevice=pci_0000_03_00
++ ./evirsh nodedev-list
++ grep -c pci_0000_03_00
+ '[' 1 -gt 1 ']'
+ sestatus
+ grep mls
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
    }'
++ type -t test_sanity_detach_1
+ '[' function == function ']'
+ test_sanity_detach_1
+ relabel_pci_device_files_for_domain guest1
+ sestatus
+ grep mls
+ return 0
+ start_guest_with_pci_device guest1
+ local rc=0
+ create_guest_domain guest1 pci_dev.xml
+ '[' '!' -z pci_dev.xml ']'
+ /bin/sed '/HOSTDEV_CONFIG/ {r pci_dev.xml
        d}' guest1-template.xml
+ append_cleanup '/bin/rm -f guest1.xml'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
	/bin/rm -f guest1.xml
    }'
+ prepend_cleanup './evirsh destroy guest1'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	./evirsh destroy guest1
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1.xml
    }'
+ append_cleanup './evirsh nodedev-reattach pci_0000_03_00_0'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    ./evirsh destroy guest1;
    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1.xml
	./evirsh nodedev-reattach pci_0000_03_00_0
    }'
+ ./evirsh create guest1.xml
spawn virsh create guest1.xml
Please enter your authentication name: eal
Please enter your password: 
error: Failed to create domain from guest1.xml
error: unsupported configuration: host doesn't support passthrough of host PCI devices

+ return 0
+ check_device_driver pci-stub
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 == x ']'
++ basename ../../../../../bus/pci/drivers/bnx2
+ test bnx2 == pci-stub
+ return 1
+ (( rc+=2 ))
++ get_guest_domain_pid guest1
++ ./evirsh --readonly list
++ grep guest1
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
++ return
+ pid_maps=
+ check_proc_pid_maps
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 = x ']'
+ grep -e f8000000 /proc//maps
grep: /proc//maps: No such file or directory
+ return 2
+ (( rc+=4 ))
+ return 6
+ exit_fail 'Failed to start guest with assigned PCI 0000:03:00.0'
+ [[ -n Failed to start guest with assigned PCI 0000:03:00.0 ]]
+ printf '\nexit_fail: %s\n' 'Failed to start guest with assigned PCI 0000:03:00.0'

exit_fail: Failed to start guest with assigned PCI 0000:03:00.0
+ exit 1
+ test_cleanup
+ ./evirsh destroy guest1
spawn virsh destroy guest1
Please enter your authentication name: eal
Please enter your password: 
error: failed to get domain 'guest1'
error: Domain not found: no domain with matching name 'guest1'

+ rm -f /tmp/tmp.0c3U0Utfy7 /tmp/tmp.KtyjrFSrOk /usr/local/eal4_testing/audit-test/tmp.GS1bgFGTKn
+ /bin/rm -f /var/lib/libvirt/images/guest1.img
+ /bin/rm -f /var/lib/libvirt/images/guest2.img
+ /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
+ /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource /sys/bus/pci/devices/0000:03:00.0/resource0
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
restorecon:  lstat(/sys/bus/pci/devices/0000:03:00.0/rom) failed:  No such file or directory
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
+ /bin/rm -f guest1.xml
+ ./evirsh nodedev-reattach pci_0000_03_00_0
spawn virsh nodedev-reattach pci_0000_03_00_0
Please enter your authentication name: eal
Please enter your password: 
Device pci_0000_03_00_0 re-attached

+ exit

augrok output
-------------
Argument "enabled 1\nfailure 1\npid 942\nrate_limit 0\nbacklog_lim..." isn't numeric in numeric eq (==) at /usr/local/eal4_testing/audit-test/utils/augrok line 1209.
type=VIRT_MACHINE_ID msg=audit(1623664221.224:404): pid=2030 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1" uuid=16aed771-0780-4ed8-a8eb-33d7f6ac94da vm-ctx=system_u:system_r:svirt_t:s0:c50,c70 img-ctx=system_u:object_r:svirt_image_t:s0:c50,c70 model=selinux exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_MACHINE_ID msg=audit(1623664221.224:405): pid=2030 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1" uuid=16aed771-0780-4ed8-a8eb-33d7f6ac94da vm-ctx=+107:+107 img-ctx=+107:+107 model=dac exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=SERVICE_START msg=audit(1623664221.271:406): pid=1 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:init_t:s0 msg_1='unit=virtlogd comm="systemd" exe="/usr/lib/systemd/systemd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623664222.169:407): pid=2030 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=disk reason=start vm="guest1" uuid=16aed771-0780-4ed8-a8eb-33d7f6ac94da old-disk="?" new-disk="/var/lib/libvirt/images/guest1.img" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623664222.169:408): pid=2030 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=dev reason=start vm="guest1" uuid=16aed771-0780-4ed8-a8eb-33d7f6ac94da bus=pci device="0000:03:00.0" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623664222.169:409): pid=2030 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=mem reason=start vm="guest1" uuid=16aed771-0780-4ed8-a8eb-33d7f6ac94da old-mem=0 new-mem=262144 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623664222.169:410): pid=2030 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=vcpu reason=start vm="guest1" uuid=16aed771-0780-4ed8-a8eb-33d7f6ac94da old-vcpu=0 new-vcpu=1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_CONTROL msg=audit(1623664222.169:411): pid=2030 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm op=start reason=booted vm="guest1" uuid=16aed771-0780-4ed8-a8eb-33d7f6ac94da vm-pid=-1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=failed'
type=ANOM_PROMISCUOUS msg=audit(1623664222.753:412): dev=eno1 prom=0 old_prom=256 auid=4294967295 uid=0 gid=0 ses=4294967295
type=SYSCALL msg=audit(1623664222.753:412): arch=c000003e syscall=1 success=yes exit=12 a0=1b a1=7f70b40d4ee4 a2=c a3=2e30303a33303a30 items=0 ppid=1 pid=2030 auid=4294967295 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=(none) ses=4294967295 comm=libvirtd exe=/usr/sbin/libvirtd subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 key=(null)
type=PROCTITLE msg=audit(1623664222.753:412): proctitle=2F7573722F7362696E2F6C69627669727464002D2D6C697374656E
--- end output -------------------------------------------------------------


Testcase                                                                                                                                                            Result
--------                                                                                                                                                            ------
[1] usb_passthrough dynamic_attach_on_boot                                                                                                                       ERROR (2)
        USB device 0781:5581 not found
--- begin output -----------------------------------------------------------
rotate_audit_logs: Attempting to rotate using USR1
+ source testcase.bash
++ source functions.bash
+++ [[ -z '' ]]
+++ _FUNCTIONS_BASH=1
+++ shopt -s extglob
+++ unset auditd_conf audit_log
+++ auditd_conf=/etc/audit/auditd.conf
+++ audit_log=/var/log/audit/audit.log
+++ unset zero
+++ zero=test_usb_passthrough.bash
+++ [[ capp == lspp ]]
++ [[ -n '' ]]
+++ mktemp -p /usr/local/eal4_testing/audit-test
++ localtmp=/usr/local/eal4_testing/audit-test/tmp.4tUJWsWFB6
+++ mktemp
++ tmp1=/tmp/tmp.UVfAliHnLd
+++ mktemp
++ tmp2=/tmp/tmp.bdE0uAQaQW
++ trap 'test_cleanup; exit' 0 1 2 15
+ source usb_device.conf
++ usb_device_id=0781:5581
+ source tp_luks_functions.bash
++ '[' -z ']'
+++ losetup -f
++ LOOPDEV=/dev/loop0
++ TIMEOUT=120
+ AUDIT_LOG=/var/log/audit/audit.log
+ USB_DEFCON=usb_device_t
+ scenario=dynamic_attach_on_boot
+ pkg_list='qemu-kvm libvirt libvirt-client'
+ [[ 0781:5581 == *X* ]]
++ echo 0781:5581
++ cut -d: -f1
+ usb_vendor=0781
+ '[' x = x0781 ']'
++ echo 0781:5581
++ cut -d: -f2
+ usb_product=5581
+ '[' x = x5581 ']'
++ lsusb
++ grep -m1 0781:5581
++ tr : ' '
++ cut '-d ' -f2
+ usb_bus=
+ '[' x = x ']'
+ exit_error 'USB device 0781:5581 not found'
+ declare status
+ [[ -n USB device 0781:5581 not found ]]
+ [[ USB device 0781:5581 not found != *[!0-9]* ]]
+ status=2
+ [[ -n USB device 0781:5581 not found ]]
+ printf '\nexit_error: %s\n' 'USB device 0781:5581 not found'

exit_error: USB device 0781:5581 not found
+ exit 2
+ test_cleanup
+ rm -f /tmp/tmp.UVfAliHnLd /tmp/tmp.bdE0uAQaQW /usr/local/eal4_testing/audit-test/tmp.4tUJWsWFB6
+ exit
--- end output -------------------------------------------------------------


Testcase                                                                                                                                                            Result
--------                                                                                                                                                            ------
[2] pci_passthrough sanity_detach_1                                                                                                                                  FAIL 
        Failed to start guest with assigned PCI 0000:03:00.0
--- begin output -----------------------------------------------------------
rotate_audit_logs: Attempting to rotate using USR1
+ source testcase.bash
++ source functions.bash
+++ [[ -z '' ]]
+++ _FUNCTIONS_BASH=1
+++ shopt -s extglob
+++ unset auditd_conf audit_log
+++ auditd_conf=/etc/audit/auditd.conf
+++ audit_log=/var/log/audit/audit.log
+++ unset zero
+++ zero=test_pci_passthrough.bash
+++ [[ capp == lspp ]]
++ [[ -n '' ]]
+++ mktemp -p /usr/local/eal4_testing/audit-test
++ localtmp=/usr/local/eal4_testing/audit-test/tmp.dpD2TL8iKb
+++ mktemp
++ tmp1=/tmp/tmp.ZmrIpL7WgB
+++ mktemp
++ tmp2=/tmp/tmp.HhLxwyPqpB
++ trap 'test_cleanup; exit' 0 1 2 15
+ source pci_device.conf
++ pci_device=0000:03:00.0
+ source tp_luks_functions.bash
++ '[' -z ']'
+++ losetup -f
++ LOOPDEV=/dev/loop0
++ TIMEOUT=120
+ PCI_DEFCON=sysfs_t
+ scenario=sanity_detach_1
+ pkg_list='qemu-kvm libvirt libvirt-client'
+ pkg_list=bash
++ lspci -vvv -s 0000:03:00.0
++ sed -ne 's/Region.*Memory at \([a-f0-9]\{8\}\) .*/-e \1/p'
+ pci_regions='	-e f8000000'
+ [[ 0000:03:00.0 == *X* ]]
++ echo 0000:03:00.0
++ tr :. _
+ pci_device_name=pci_0000_03_00_0
++ echo 0000:03:00.0
++ cut -d: -f1
+ pci_domain=0000
++ echo 0000:03:00.0
++ cut -d: -f2
+ pci_bus=03
++ echo 0000:03:00.0
++ cut -d: -f3
++ sed 's/\..*//'
+ pci_slot=00
++ echo 0000:03:00.0
++ cut -d. -f2
+ pci_function=0
+ dom1=guest1
+ dom2=guest2
+ dom3=guest1-dynamic
+ dom4=guest2-dynamic
+ img_path=/var/lib/libvirt/images
++ cat /proc/sys/crypto/fips_enabled
+ FIPS=0
+ '[' x0 = x1 ']'
+ '[' -z sanity_detach_1 ']'
+ set_selinux_booleans
+ /usr/sbin/getsebool virt_use_sysfs
+ grep off
Error getting active value for virt_use_sysfs
+ /usr/sbin/setsebool virt_use_sysfs 1
Could not change active booleans: Invalid boolean
+ reload_kvm_module_for_unsafe_interrupts
+ ./evirsh --readonly list
+ grep running
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
+ /sbin/modprobe -r kvm_intel
+ /sbin/modprobe -r kvm
+ /sbin/modprobe kvm allow_unsafe_assigned_interrupts=1
modprobe: ERROR: could not insert 'kvm': Unknown symbol in module, or unknown parameter (see dmesg)
+ /sbin/modprobe kvm_intel
+ check_kernel_boot_cmdline
+ /bin/grep intel_iommu=on /proc/cmdline
BOOT_IMAGE=/rhvh-4.3.10.1-0.20200513.0+1/vmlinuz-3.10.0-1127.8.2.el7.x86_64 root=/dev/rhvh/rhvh-4.3.10.1-0.20200513.0+1 ro crashkernel=auto rd.lvm.lv=rhvh/swap rhgb quiet intel_iommu=on rd.lvm.lv=rhvh/rhvh-4.3.10.1-0.20200513.0+1 img.bootid=rhvh-4.3.10.1-0.20200513.0+1
+ return 0
+ check_enabled_iommu
+ /bin/dmesg
+ /bin/grep 'IOMMU.*enabled'
[    0.000000] DMAR: IOMMU enabled
+ return 0
+ check_virt_extensions
+ /bin/grep vmx /proc/cpuinfo
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
+ return 0
+ check_selinux_booleans
+ return 0
+ check_kvm_modules
+ /sbin/lsmod
+ /bin/grep kvm_intel
kvm_intel             188688  0 
kvm                   636965  1 kvm_intel
+ return 0
+ check_installed_packages bash
+ /bin/rpm -q bash
bash-4.2.46-34.el7.x86_64
+ return 0
+ prepare_guest_domains
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00182606 s, 574 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00178031 s, 589 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00179613 s, 584 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00180362 s, 581 MB/s
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c50,c70 /var/lib/libvirt/images/guest1.img
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c19,c83 /var/lib/libvirt/images/guest2.img
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp"
	/bin/rm -f /var/lib/libvirt/images/guest1.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img
	/bin/rm -f /var/lib/libvirt/images/guest2.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img
	/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
	/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
    }'
+ generate_pci_dev_file
+ /bin/cat
+ detach_multifunction_devices
++ echo pci_0000:03:00.0
++ tr :. _
+ pcifunction=pci_0000_03_00_0
++ echo pci_0000_03_00_0
++ sed 's/_[0-9]\+$//g'
+ pcidevice=pci_0000_03_00
++ ./evirsh nodedev-list
++ grep -c pci_0000_03_00
+ '[' 1 -gt 1 ']'
+ sestatus
+ grep mls
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
    }'
++ type -t test_sanity_detach_1
+ '[' function == function ']'
+ test_sanity_detach_1
+ relabel_pci_device_files_for_domain guest1
+ sestatus
+ grep mls
+ return 0
+ start_guest_with_pci_device guest1
+ local rc=0
+ create_guest_domain guest1 pci_dev.xml
+ '[' '!' -z pci_dev.xml ']'
+ /bin/sed '/HOSTDEV_CONFIG/ {r pci_dev.xml
        d}' guest1-template.xml
+ append_cleanup '/bin/rm -f guest1.xml'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
	/bin/rm -f guest1.xml
    }'
+ prepend_cleanup './evirsh destroy guest1'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	./evirsh destroy guest1
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1.xml
    }'
+ append_cleanup './evirsh nodedev-reattach pci_0000_03_00_0'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    ./evirsh destroy guest1;
    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1.xml
	./evirsh nodedev-reattach pci_0000_03_00_0
    }'
+ ./evirsh create guest1.xml
spawn virsh create guest1.xml
Please enter your authentication name: eal
Please enter your password: 
error: Failed to create domain from guest1.xml
error: unsupported configuration: host doesn't support passthrough of host PCI devices

+ return 0
+ check_device_driver pci-stub
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 == x ']'
++ basename ../../../../../bus/pci/drivers/bnx2
+ test bnx2 == pci-stub
+ return 1
+ (( rc+=2 ))
++ get_guest_domain_pid guest1
++ ./evirsh --readonly list
++ grep guest1
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
++ return
+ pid_maps=
+ check_proc_pid_maps
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 = x ']'
+ grep -e f8000000 /proc//maps
grep: /proc//maps: No such file or directory
+ return 2
+ (( rc+=4 ))
+ return 6
+ exit_fail 'Failed to start guest with assigned PCI 0000:03:00.0'
+ [[ -n Failed to start guest with assigned PCI 0000:03:00.0 ]]
+ printf '\nexit_fail: %s\n' 'Failed to start guest with assigned PCI 0000:03:00.0'

exit_fail: Failed to start guest with assigned PCI 0000:03:00.0
+ exit 1
+ test_cleanup
+ ./evirsh destroy guest1
spawn virsh destroy guest1
Please enter your authentication name: eal
Please enter your password: 
error: failed to get domain 'guest1'
error: Domain not found: no domain with matching name 'guest1'

+ rm -f /tmp/tmp.ZmrIpL7WgB /tmp/tmp.HhLxwyPqpB /usr/local/eal4_testing/audit-test/tmp.dpD2TL8iKb
+ /bin/rm -f /var/lib/libvirt/images/guest1.img
+ /bin/rm -f /var/lib/libvirt/images/guest2.img
+ /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
+ /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource /sys/bus/pci/devices/0000:03:00.0/resource0
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
restorecon:  lstat(/sys/bus/pci/devices/0000:03:00.0/rom) failed:  No such file or directory
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
+ /bin/rm -f guest1.xml
+ ./evirsh nodedev-reattach pci_0000_03_00_0
spawn virsh nodedev-reattach pci_0000_03_00_0
Please enter your authentication name: eal
Please enter your password: 
Device pci_0000_03_00_0 re-attached

+ exit

augrok output
-------------
Argument "enabled 1\nfailure 1\npid 943\nrate_limit 0\nbacklog_lim..." isn't numeric in numeric eq (==) at /usr/local/eal4_testing/audit-test/utils/augrok line 1209.
type=VIRT_MACHINE_ID msg=audit(1623663277.282:469): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1" uuid=86b46b52-d247-4556-8ce7-6a437c297bd0 vm-ctx=system_u:system_r:svirt_t:s0:c50,c70 img-ctx=system_u:object_r:svirt_image_t:s0:c50,c70 model=selinux exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_MACHINE_ID msg=audit(1623663277.282:470): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1" uuid=86b46b52-d247-4556-8ce7-6a437c297bd0 vm-ctx=+107:+107 img-ctx=+107:+107 model=dac exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663278.049:471): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=disk reason=start vm="guest1" uuid=86b46b52-d247-4556-8ce7-6a437c297bd0 old-disk="?" new-disk="/var/lib/libvirt/images/guest1.img" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663278.049:472): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=dev reason=start vm="guest1" uuid=86b46b52-d247-4556-8ce7-6a437c297bd0 bus=pci device="0000:03:00.0" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663278.049:473): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=mem reason=start vm="guest1" uuid=86b46b52-d247-4556-8ce7-6a437c297bd0 old-mem=0 new-mem=262144 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663278.049:474): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=vcpu reason=start vm="guest1" uuid=86b46b52-d247-4556-8ce7-6a437c297bd0 old-vcpu=0 new-vcpu=1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_CONTROL msg=audit(1623663278.049:475): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm op=start reason=booted vm="guest1" uuid=86b46b52-d247-4556-8ce7-6a437c297bd0 vm-pid=-1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=failed'
--- end output -------------------------------------------------------------


Testcase                                                                                                                                                            Result
--------                                                                                                                                                            ------
[3] pci_passthrough sanity_detach_2                                                                                                                                  FAIL 
        Attach failed
--- begin output -----------------------------------------------------------
rotate_audit_logs: Attempting to rotate using USR1
+ source testcase.bash
++ source functions.bash
+++ [[ -z '' ]]
+++ _FUNCTIONS_BASH=1
+++ shopt -s extglob
+++ unset auditd_conf audit_log
+++ auditd_conf=/etc/audit/auditd.conf
+++ audit_log=/var/log/audit/audit.log
+++ unset zero
+++ zero=test_pci_passthrough.bash
+++ [[ capp == lspp ]]
++ [[ -n '' ]]
+++ mktemp -p /usr/local/eal4_testing/audit-test
++ localtmp=/usr/local/eal4_testing/audit-test/tmp.92dLv6RnRN
+++ mktemp
++ tmp1=/tmp/tmp.g05TF9YRaA
+++ mktemp
++ tmp2=/tmp/tmp.EYCdCfA1yc
++ trap 'test_cleanup; exit' 0 1 2 15
+ source pci_device.conf
++ pci_device=0000:03:00.0
+ source tp_luks_functions.bash
++ '[' -z ']'
+++ losetup -f
++ LOOPDEV=/dev/loop0
++ TIMEOUT=120
+ PCI_DEFCON=sysfs_t
+ scenario=sanity_detach_2
+ pkg_list='qemu-kvm libvirt libvirt-client'
+ pkg_list=bash
++ lspci -vvv -s 0000:03:00.0
++ sed -ne 's/Region.*Memory at \([a-f0-9]\{8\}\) .*/-e \1/p'
+ pci_regions='	-e f8000000'
+ [[ 0000:03:00.0 == *X* ]]
++ echo 0000:03:00.0
++ tr :. _
+ pci_device_name=pci_0000_03_00_0
++ echo 0000:03:00.0
++ cut -d: -f1
+ pci_domain=0000
++ echo 0000:03:00.0
++ cut -d: -f2
+ pci_bus=03
++ echo 0000:03:00.0
++ cut -d: -f3
++ sed 's/\..*//'
+ pci_slot=00
++ echo 0000:03:00.0
++ cut -d. -f2
+ pci_function=0
+ dom1=guest1
+ dom2=guest2
+ dom3=guest1-dynamic
+ dom4=guest2-dynamic
+ img_path=/var/lib/libvirt/images
++ cat /proc/sys/crypto/fips_enabled
+ FIPS=0
+ '[' x0 = x1 ']'
+ '[' -z sanity_detach_2 ']'
+ set_selinux_booleans
+ /usr/sbin/getsebool virt_use_sysfs
+ grep off
Error getting active value for virt_use_sysfs
+ /usr/sbin/setsebool virt_use_sysfs 1
Could not change active booleans: Invalid boolean
+ reload_kvm_module_for_unsafe_interrupts
+ ./evirsh --readonly list
+ grep running
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
+ /sbin/modprobe -r kvm_intel
+ /sbin/modprobe -r kvm
+ /sbin/modprobe kvm allow_unsafe_assigned_interrupts=1
modprobe: ERROR: could not insert 'kvm': Unknown symbol in module, or unknown parameter (see dmesg)
+ /sbin/modprobe kvm_intel
+ check_kernel_boot_cmdline
+ /bin/grep intel_iommu=on /proc/cmdline
BOOT_IMAGE=/rhvh-4.3.10.1-0.20200513.0+1/vmlinuz-3.10.0-1127.8.2.el7.x86_64 root=/dev/rhvh/rhvh-4.3.10.1-0.20200513.0+1 ro crashkernel=auto rd.lvm.lv=rhvh/swap rhgb quiet intel_iommu=on rd.lvm.lv=rhvh/rhvh-4.3.10.1-0.20200513.0+1 img.bootid=rhvh-4.3.10.1-0.20200513.0+1
+ return 0
+ check_enabled_iommu
+ /bin/dmesg
+ /bin/grep 'IOMMU.*enabled'
[    0.000000] DMAR: IOMMU enabled
+ return 0
+ check_virt_extensions
+ /bin/grep vmx /proc/cpuinfo
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
+ return 0
+ check_selinux_booleans
+ return 0
+ check_kvm_modules
+ /sbin/lsmod
+ /bin/grep kvm_intel
kvm_intel             188688  0 
kvm                   636965  1 kvm_intel
+ return 0
+ check_installed_packages bash
+ /bin/rpm -q bash
bash-4.2.46-34.el7.x86_64
+ return 0
+ prepare_guest_domains
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.001813 s, 578 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.0017805 s, 589 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00177711 s, 590 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00181714 s, 577 MB/s
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c50,c70 /var/lib/libvirt/images/guest1.img
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c19,c83 /var/lib/libvirt/images/guest2.img
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp"
	/bin/rm -f /var/lib/libvirt/images/guest1.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img
	/bin/rm -f /var/lib/libvirt/images/guest2.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img
	/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
	/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
    }'
+ generate_pci_dev_file
+ /bin/cat
+ detach_multifunction_devices
++ echo pci_0000:03:00.0
++ tr :. _
+ pcifunction=pci_0000_03_00_0
++ echo pci_0000_03_00_0
++ sed 's/_[0-9]\+$//g'
+ pcidevice=pci_0000_03_00
++ ./evirsh nodedev-list
++ grep -c pci_0000_03_00
+ '[' 1 -gt 1 ']'
+ sestatus
+ grep mls
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
    }'
++ type -t test_sanity_detach_2
+ '[' function == function ']'
+ test_sanity_detach_2
+ start_guest_without_pci_device guest1
+ create_guest_domain guest1
+ '[' '!' -z '' ']'
+ /bin/sed s/HOSTDEV_CONFIG// guest1-template.xml
+ append_cleanup '/bin/rm -f guest1.xml'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
	/bin/rm -f guest1.xml
    }'
+ prepend_cleanup './evirsh destroy guest1'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	./evirsh destroy guest1
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1.xml
    }'
+ append_cleanup './evirsh nodedev-reattach pci_0000_03_00_0'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    ./evirsh destroy guest1;
    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1.xml
	./evirsh nodedev-reattach pci_0000_03_00_0
    }'
+ ./evirsh create guest1.xml
spawn virsh create guest1.xml
Please enter your authentication name: eal
Please enter your password: 
Domain guest1 created from guest1.xml

+ return 0
+ return 0
+ '[' x0 = x1 ']'
+ relabel_pci_device_files_for_domain guest1
+ sestatus
+ grep mls
+ return 0
+ attach_pci_device 1 guest1 guest1 guest2
+ local rc=0
+ case $1 in
+ ./evirsh attach-device guest1 pci_dev.xml
spawn virsh attach-device guest1 pci_dev.xml
Please enter your authentication name: eal
Please enter your password: 
error: Failed to attach device from pci_dev.xml
error: unsupported configuration: host doesn't support passthrough of host PCI devices

+ check_device_driver pci-stub
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 == x ']'
++ basename ../../../../../bus/pci/drivers/bnx2
+ test bnx2 == pci-stub
+ return 1
+ (( rc+=2 ))
++ get_guest_domain_pid guest1
++ ./evirsh --readonly list
++ grep guest1
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
++ return
+ pid_maps=
++ get_guest_domain_pid guest2
++ ./evirsh --readonly list
++ grep guest2
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
++ return
+ pid_nomaps=
+ check_proc_pid_maps
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 = x ']'
+ grep -e f8000000 /proc//maps
grep: /proc//maps: No such file or directory
+ return 2
+ (( rc+=4 ))
+ '[' '!' -z ']'
+ return 6
+ exit_fail 'Attach failed'
+ [[ -n Attach failed ]]
+ printf '\nexit_fail: %s\n' 'Attach failed'

exit_fail: Attach failed
+ exit 1
+ test_cleanup
+ ./evirsh destroy guest1
spawn virsh destroy guest1
Please enter your authentication name: eal
Please enter your password: 
Domain guest1 destroyed

+ rm -f /tmp/tmp.g05TF9YRaA /tmp/tmp.EYCdCfA1yc /usr/local/eal4_testing/audit-test/tmp.92dLv6RnRN
+ /bin/rm -f /var/lib/libvirt/images/guest1.img
+ /bin/rm -f /var/lib/libvirt/images/guest2.img
+ /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
+ /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource /sys/bus/pci/devices/0000:03:00.0/resource0
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
restorecon:  lstat(/sys/bus/pci/devices/0000:03:00.0/rom) failed:  No such file or directory
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
+ /bin/rm -f guest1.xml
+ ./evirsh nodedev-reattach pci_0000_03_00_0
spawn virsh nodedev-reattach pci_0000_03_00_0
Please enter your authentication name: eal
Please enter your password: 
Device pci_0000_03_00_0 re-attached

+ exit

augrok output
-------------
Argument "enabled 1\nfailure 1\npid 943\nrate_limit 0\nbacklog_lim..." isn't numeric in numeric eq (==) at /usr/local/eal4_testing/audit-test/utils/augrok line 1209.
type=VIRT_MACHINE_ID msg=audit(1623663280.227:476): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 vm-ctx=system_u:system_r:svirt_t:s0:c50,c70 img-ctx=system_u:object_r:svirt_image_t:s0:c50,c70 model=selinux exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_MACHINE_ID msg=audit(1623663280.228:477): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 vm-ctx=+107:+107 img-ctx=+107:+107 model=dac exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663280.649:478): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=deny vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d4\x2dguest1.scope/" class=all exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663280.649:479): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d4\x2dguest1.scope/" class=major category=pty maj=88 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663280.649:480): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d4\x2dguest1.scope/" class=path path="/dev/null" rdev=01:03 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663280.649:481): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d4\x2dguest1.scope/" class=path path="/dev/full" rdev=01:07 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663280.649:482): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d4\x2dguest1.scope/" class=path path="/dev/zero" rdev=01:05 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663280.649:483): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d4\x2dguest1.scope/" class=path path="/dev/random" rdev=01:08 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663280.650:484): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d4\x2dguest1.scope/" class=path path="/dev/urandom" rdev=01:09 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663280.650:485): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d4\x2dguest1.scope/" class=path path="/dev/ptmx" rdev=05:02 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663280.650:486): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d4\x2dguest1.scope/" class=path path="/dev/kvm" rdev=0A:E8 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663280.650:487): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d4\x2dguest1.scope/" class=path path="/dev/rtc" rdev=FC:00 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663280.650:488): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d4\x2dguest1.scope/" class=path path="/dev/hpet" rdev=0A:E4 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663281.284:489): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=disk reason=start vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 old-disk="?" new-disk="/var/lib/libvirt/images/guest1.img" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663281.284:490): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=chardev reason=start vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 old-chardev="?" new-chardev="/dev/pts/2" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663281.284:491): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=mem reason=start vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 old-mem=0 new-mem=262144 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663281.284:492): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=vcpu reason=start vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 old-vcpu=0 new-vcpu=1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_CONTROL msg=audit(1623663281.284:493): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm op=start reason=booted vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 vm-pid=5053 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_CONTROL msg=audit(1623663282.924:494): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm op=stop reason=destroyed vm="guest1" uuid=243efd2a-e693-48bc-9f33-9c75ad73ddf4 vm-pid=-1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
--- end output -------------------------------------------------------------


Testcase                                                                                                                                                            Result
--------                                                                                                                                                            ------
[4] pci_passthrough simple_double_attach                                                                                                                             FAIL 
        Attach failed
--- begin output -----------------------------------------------------------
rotate_audit_logs: Attempting to rotate using USR1
+ source testcase.bash
++ source functions.bash
+++ [[ -z '' ]]
+++ _FUNCTIONS_BASH=1
+++ shopt -s extglob
+++ unset auditd_conf audit_log
+++ auditd_conf=/etc/audit/auditd.conf
+++ audit_log=/var/log/audit/audit.log
+++ unset zero
+++ zero=test_pci_passthrough.bash
+++ [[ capp == lspp ]]
++ [[ -n '' ]]
+++ mktemp -p /usr/local/eal4_testing/audit-test
++ localtmp=/usr/local/eal4_testing/audit-test/tmp.4X5EqvrP3U
+++ mktemp
++ tmp1=/tmp/tmp.t0mQ42170I
+++ mktemp
++ tmp2=/tmp/tmp.vm14ohe5Jm
++ trap 'test_cleanup; exit' 0 1 2 15
+ source pci_device.conf
++ pci_device=0000:03:00.0
+ source tp_luks_functions.bash
++ '[' -z ']'
+++ losetup -f
++ LOOPDEV=/dev/loop0
++ TIMEOUT=120
+ PCI_DEFCON=sysfs_t
+ scenario=simple_double_attach
+ pkg_list='qemu-kvm libvirt libvirt-client'
+ pkg_list=bash
++ lspci -vvv -s 0000:03:00.0
++ sed -ne 's/Region.*Memory at \([a-f0-9]\{8\}\) .*/-e \1/p'
+ pci_regions='	-e f8000000'
+ [[ 0000:03:00.0 == *X* ]]
++ echo 0000:03:00.0
++ tr :. _
+ pci_device_name=pci_0000_03_00_0
++ echo 0000:03:00.0
++ cut -d: -f1
+ pci_domain=0000
++ echo 0000:03:00.0
++ cut -d: -f2
+ pci_bus=03
++ echo 0000:03:00.0
++ cut -d: -f3
++ sed 's/\..*//'
+ pci_slot=00
++ echo 0000:03:00.0
++ cut -d. -f2
+ pci_function=0
+ dom1=guest1
+ dom2=guest2
+ dom3=guest1-dynamic
+ dom4=guest2-dynamic
+ img_path=/var/lib/libvirt/images
++ cat /proc/sys/crypto/fips_enabled
+ FIPS=0
+ '[' x0 = x1 ']'
+ '[' -z simple_double_attach ']'
+ set_selinux_booleans
+ /usr/sbin/getsebool virt_use_sysfs
+ grep off
Error getting active value for virt_use_sysfs
+ /usr/sbin/setsebool virt_use_sysfs 1
Could not change active booleans: Invalid boolean
+ reload_kvm_module_for_unsafe_interrupts
+ ./evirsh --readonly list
+ grep running
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
+ /sbin/modprobe -r kvm_intel
+ /sbin/modprobe -r kvm
+ /sbin/modprobe kvm allow_unsafe_assigned_interrupts=1
modprobe: ERROR: could not insert 'kvm': Unknown symbol in module, or unknown parameter (see dmesg)
+ /sbin/modprobe kvm_intel
+ check_kernel_boot_cmdline
+ /bin/grep intel_iommu=on /proc/cmdline
BOOT_IMAGE=/rhvh-4.3.10.1-0.20200513.0+1/vmlinuz-3.10.0-1127.8.2.el7.x86_64 root=/dev/rhvh/rhvh-4.3.10.1-0.20200513.0+1 ro crashkernel=auto rd.lvm.lv=rhvh/swap rhgb quiet intel_iommu=on rd.lvm.lv=rhvh/rhvh-4.3.10.1-0.20200513.0+1 img.bootid=rhvh-4.3.10.1-0.20200513.0+1
+ return 0
+ check_enabled_iommu
+ /bin/dmesg
+ /bin/grep 'IOMMU.*enabled'
[    0.000000] DMAR: IOMMU enabled
+ return 0
+ check_virt_extensions
+ /bin/grep vmx /proc/cpuinfo
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
+ return 0
+ check_selinux_booleans
+ return 0
+ check_kvm_modules
+ /sbin/lsmod
+ /bin/grep kvm_intel
kvm_intel             188688  0 
kvm                   636965  1 kvm_intel
+ return 0
+ check_installed_packages bash
+ /bin/rpm -q bash
bash-4.2.46-34.el7.x86_64
+ return 0
+ prepare_guest_domains
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00179702 s, 584 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00178264 s, 588 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00183181 s, 572 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00198328 s, 529 MB/s
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c50,c70 /var/lib/libvirt/images/guest1.img
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c19,c83 /var/lib/libvirt/images/guest2.img
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp"
	/bin/rm -f /var/lib/libvirt/images/guest1.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img
	/bin/rm -f /var/lib/libvirt/images/guest2.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img
	/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
	/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
    }'
+ generate_pci_dev_file
+ /bin/cat
+ detach_multifunction_devices
++ echo pci_0000:03:00.0
++ tr :. _
+ pcifunction=pci_0000_03_00_0
++ echo pci_0000_03_00_0
++ sed 's/_[0-9]\+$//g'
+ pcidevice=pci_0000_03_00
++ ./evirsh nodedev-list
++ grep -c pci_0000_03_00
+ '[' 1 -gt 1 ']'
+ sestatus
+ grep mls
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
    }'
++ type -t test_simple_double_attach
+ '[' function == function ']'
+ test_simple_double_attach
+ start_guest_without_pci_device guest1
+ create_guest_domain guest1
+ '[' '!' -z '' ']'
+ /bin/sed s/HOSTDEV_CONFIG// guest1-template.xml
+ append_cleanup '/bin/rm -f guest1.xml'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
	/bin/rm -f guest1.xml
    }'
+ prepend_cleanup './evirsh destroy guest1'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	./evirsh destroy guest1
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1.xml
    }'
+ append_cleanup './evirsh nodedev-reattach pci_0000_03_00_0'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    ./evirsh destroy guest1;
    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1.xml
	./evirsh nodedev-reattach pci_0000_03_00_0
    }'
+ ./evirsh create guest1.xml
spawn virsh create guest1.xml
Please enter your authentication name: eal
Please enter your password: 
Domain guest1 created from guest1.xml

+ return 0
+ return 0
+ '[' x0 = x1 ']'
+ relabel_pci_device_files_for_domain guest1
+ sestatus
+ grep mls
+ return 0
+ attach_pci_device 1 guest1 guest1 guest2
+ local rc=0
+ case $1 in
+ ./evirsh attach-device guest1 pci_dev.xml
spawn virsh attach-device guest1 pci_dev.xml
Please enter your authentication name: eal
Please enter your password: 
error: Failed to attach device from pci_dev.xml
error: unsupported configuration: host doesn't support passthrough of host PCI devices

+ check_device_driver pci-stub
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 == x ']'
++ basename ../../../../../bus/pci/drivers/bnx2
+ test bnx2 == pci-stub
+ return 1
+ (( rc+=2 ))
++ get_guest_domain_pid guest1
++ ./evirsh --readonly list
++ grep guest1
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
++ return
+ pid_maps=
++ get_guest_domain_pid guest2
++ ./evirsh --readonly list
++ grep guest2
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
++ return
+ pid_nomaps=
+ check_proc_pid_maps
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 = x ']'
+ grep -e f8000000 /proc//maps
grep: /proc//maps: No such file or directory
+ return 2
+ (( rc+=4 ))
+ '[' '!' -z ']'
+ return 6
+ exit_fail 'Attach failed'
+ [[ -n Attach failed ]]
+ printf '\nexit_fail: %s\n' 'Attach failed'

exit_fail: Attach failed
+ exit 1
+ test_cleanup
+ ./evirsh destroy guest1
spawn virsh destroy guest1
Please enter your authentication name: eal
Please enter your password: 
Domain guest1 destroyed

+ rm -f /tmp/tmp.t0mQ42170I /tmp/tmp.vm14ohe5Jm /usr/local/eal4_testing/audit-test/tmp.4X5EqvrP3U
+ /bin/rm -f /var/lib/libvirt/images/guest1.img
+ /bin/rm -f /var/lib/libvirt/images/guest2.img
+ /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
+ /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource /sys/bus/pci/devices/0000:03:00.0/resource0
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
restorecon:  lstat(/sys/bus/pci/devices/0000:03:00.0/rom) failed:  No such file or directory
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
+ /bin/rm -f guest1.xml
+ ./evirsh nodedev-reattach pci_0000_03_00_0
spawn virsh nodedev-reattach pci_0000_03_00_0
Please enter your authentication name: eal
Please enter your password: 
Device pci_0000_03_00_0 re-attached

+ exit

augrok output
-------------
Argument "enabled 1\nfailure 1\npid 943\nrate_limit 0\nbacklog_lim..." isn't numeric in numeric eq (==) at /usr/local/eal4_testing/audit-test/utils/augrok line 1209.
type=VIRT_MACHINE_ID msg=audit(1623663284.807:495): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a vm-ctx=system_u:system_r:svirt_t:s0:c50,c70 img-ctx=system_u:object_r:svirt_image_t:s0:c50,c70 model=selinux exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_MACHINE_ID msg=audit(1623663284.807:496): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a vm-ctx=+107:+107 img-ctx=+107:+107 model=dac exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663285.236:497): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=deny vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d5\x2dguest1.scope/" class=all exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663285.237:498): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d5\x2dguest1.scope/" class=major category=pty maj=88 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663285.237:499): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d5\x2dguest1.scope/" class=path path="/dev/null" rdev=01:03 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663285.237:500): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d5\x2dguest1.scope/" class=path path="/dev/full" rdev=01:07 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663285.237:501): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d5\x2dguest1.scope/" class=path path="/dev/zero" rdev=01:05 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663285.237:502): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d5\x2dguest1.scope/" class=path path="/dev/random" rdev=01:08 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663285.237:503): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d5\x2dguest1.scope/" class=path path="/dev/urandom" rdev=01:09 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663285.237:504): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d5\x2dguest1.scope/" class=path path="/dev/ptmx" rdev=05:02 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663285.237:505): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d5\x2dguest1.scope/" class=path path="/dev/kvm" rdev=0A:E8 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663285.237:506): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d5\x2dguest1.scope/" class=path path="/dev/rtc" rdev=FC:00 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663285.237:507): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=cgroup reason=allow vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a cgroup="/sys/fs/cgroup/devices/machine.slice/machine-qemu\x2d5\x2dguest1.scope/" class=path path="/dev/hpet" rdev=0A:E4 acl=rw exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663285.877:508): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=disk reason=start vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a old-disk="?" new-disk="/var/lib/libvirt/images/guest1.img" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663285.877:509): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=chardev reason=start vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a old-chardev="?" new-chardev="/dev/pts/2" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663285.877:510): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=mem reason=start vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a old-mem=0 new-mem=262144 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663285.877:511): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=vcpu reason=start vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a old-vcpu=0 new-vcpu=1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_CONTROL msg=audit(1623663285.877:512): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm op=start reason=booted vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a vm-pid=5319 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_CONTROL msg=audit(1623663287.520:513): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm op=stop reason=destroyed vm="guest1" uuid=5ebeeafe-9b2b-427f-9859-cb582a803c6a vm-pid=-1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
--- end output -------------------------------------------------------------


Testcase                                                                                                                                                            Result
--------                                                                                                                                                            ------
[5] pci_passthrough simple_double_detach                                                                                                                             FAIL 
        Failed to start with assigned PCI 0000:03:00.0
--- begin output -----------------------------------------------------------
rotate_audit_logs: Attempting to rotate using USR1
+ source testcase.bash
++ source functions.bash
+++ [[ -z '' ]]
+++ _FUNCTIONS_BASH=1
+++ shopt -s extglob
+++ unset auditd_conf audit_log
+++ auditd_conf=/etc/audit/auditd.conf
+++ audit_log=/var/log/audit/audit.log
+++ unset zero
+++ zero=test_pci_passthrough.bash
+++ [[ capp == lspp ]]
++ [[ -n '' ]]
+++ mktemp -p /usr/local/eal4_testing/audit-test
++ localtmp=/usr/local/eal4_testing/audit-test/tmp.YyTbrqteav
+++ mktemp
++ tmp1=/tmp/tmp.f7BitTvcII
+++ mktemp
++ tmp2=/tmp/tmp.jwNBpbcC3c
++ trap 'test_cleanup; exit' 0 1 2 15
+ source pci_device.conf
++ pci_device=0000:03:00.0
+ source tp_luks_functions.bash
++ '[' -z ']'
+++ losetup -f
++ LOOPDEV=/dev/loop0
++ TIMEOUT=120
+ PCI_DEFCON=sysfs_t
+ scenario=simple_double_detach
+ pkg_list='qemu-kvm libvirt libvirt-client'
+ pkg_list=bash
++ lspci -vvv -s 0000:03:00.0
++ sed -ne 's/Region.*Memory at \([a-f0-9]\{8\}\) .*/-e \1/p'
+ pci_regions='	-e f8000000'
+ [[ 0000:03:00.0 == *X* ]]
++ echo 0000:03:00.0
++ tr :. _
+ pci_device_name=pci_0000_03_00_0
++ echo 0000:03:00.0
++ cut -d: -f1
+ pci_domain=0000
++ echo 0000:03:00.0
++ cut -d: -f2
+ pci_bus=03
++ echo 0000:03:00.0
++ cut -d: -f3
++ sed 's/\..*//'
+ pci_slot=00
++ echo 0000:03:00.0
++ cut -d. -f2
+ pci_function=0
+ dom1=guest1
+ dom2=guest2
+ dom3=guest1-dynamic
+ dom4=guest2-dynamic
+ img_path=/var/lib/libvirt/images
++ cat /proc/sys/crypto/fips_enabled
+ FIPS=0
+ '[' x0 = x1 ']'
+ '[' -z simple_double_detach ']'
+ set_selinux_booleans
+ /usr/sbin/getsebool virt_use_sysfs
+ grep off
Error getting active value for virt_use_sysfs
+ /usr/sbin/setsebool virt_use_sysfs 1
Could not change active booleans: Invalid boolean
+ reload_kvm_module_for_unsafe_interrupts
+ ./evirsh --readonly list
+ grep running
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
+ /sbin/modprobe -r kvm_intel
+ /sbin/modprobe -r kvm
+ /sbin/modprobe kvm allow_unsafe_assigned_interrupts=1
modprobe: ERROR: could not insert 'kvm': Unknown symbol in module, or unknown parameter (see dmesg)
+ /sbin/modprobe kvm_intel
+ check_kernel_boot_cmdline
+ /bin/grep intel_iommu=on /proc/cmdline
BOOT_IMAGE=/rhvh-4.3.10.1-0.20200513.0+1/vmlinuz-3.10.0-1127.8.2.el7.x86_64 root=/dev/rhvh/rhvh-4.3.10.1-0.20200513.0+1 ro crashkernel=auto rd.lvm.lv=rhvh/swap rhgb quiet intel_iommu=on rd.lvm.lv=rhvh/rhvh-4.3.10.1-0.20200513.0+1 img.bootid=rhvh-4.3.10.1-0.20200513.0+1
+ return 0
+ check_enabled_iommu
+ /bin/dmesg
+ /bin/grep 'IOMMU.*enabled'
[    0.000000] DMAR: IOMMU enabled
+ return 0
+ check_virt_extensions
+ /bin/grep vmx /proc/cpuinfo
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
+ return 0
+ check_selinux_booleans
+ return 0
+ check_kvm_modules
+ /sbin/lsmod
+ /bin/grep kvm_intel
kvm_intel             188688  0 
kvm                   636965  1 kvm_intel
+ return 0
+ check_installed_packages bash
+ /bin/rpm -q bash
bash-4.2.46-34.el7.x86_64
+ return 0
+ prepare_guest_domains
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00181674 s, 577 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00177235 s, 592 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00181331 s, 578 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00200824 s, 522 MB/s
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c50,c70 /var/lib/libvirt/images/guest1.img
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c19,c83 /var/lib/libvirt/images/guest2.img
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp"
	/bin/rm -f /var/lib/libvirt/images/guest1.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img
	/bin/rm -f /var/lib/libvirt/images/guest2.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img
	/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
	/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
    }'
+ generate_pci_dev_file
+ /bin/cat
+ detach_multifunction_devices
++ echo pci_0000:03:00.0
++ tr :. _
+ pcifunction=pci_0000_03_00_0
++ echo pci_0000_03_00_0
++ sed 's/_[0-9]\+$//g'
+ pcidevice=pci_0000_03_00
++ ./evirsh nodedev-list
++ grep -c pci_0000_03_00
+ '[' 1 -gt 1 ']'
+ sestatus
+ grep mls
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
    }'
++ type -t test_simple_double_detach
+ '[' function == function ']'
+ test_simple_double_detach
+ relabel_pci_device_files_for_domain guest1
+ sestatus
+ grep mls
+ return 0
+ start_guest_with_pci_device guest1
+ local rc=0
+ create_guest_domain guest1 pci_dev.xml
+ '[' '!' -z pci_dev.xml ']'
+ /bin/sed '/HOSTDEV_CONFIG/ {r pci_dev.xml
        d}' guest1-template.xml
+ append_cleanup '/bin/rm -f guest1.xml'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
	/bin/rm -f guest1.xml
    }'
+ prepend_cleanup './evirsh destroy guest1'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	./evirsh destroy guest1
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1.xml
    }'
+ append_cleanup './evirsh nodedev-reattach pci_0000_03_00_0'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    ./evirsh destroy guest1;
    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1.xml
	./evirsh nodedev-reattach pci_0000_03_00_0
    }'
+ ./evirsh create guest1.xml
spawn virsh create guest1.xml
Please enter your authentication name: eal
Please enter your password: 
error: Failed to create domain from guest1.xml
error: unsupported configuration: host doesn't support passthrough of host PCI devices

+ return 0
+ check_device_driver pci-stub
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 == x ']'
++ basename ../../../../../bus/pci/drivers/bnx2
+ test bnx2 == pci-stub
+ return 1
+ (( rc+=2 ))
++ get_guest_domain_pid guest1
++ ./evirsh --readonly list
++ grep guest1
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
++ return
+ pid_maps=
+ check_proc_pid_maps
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 = x ']'
+ grep -e f8000000 /proc//maps
grep: /proc//maps: No such file or directory
+ return 2
+ (( rc+=4 ))
+ return 6
+ exit_fail 'Failed to start with assigned PCI 0000:03:00.0'
+ [[ -n Failed to start with assigned PCI 0000:03:00.0 ]]
+ printf '\nexit_fail: %s\n' 'Failed to start with assigned PCI 0000:03:00.0'

exit_fail: Failed to start with assigned PCI 0000:03:00.0
+ exit 1
+ test_cleanup
+ ./evirsh destroy guest1
spawn virsh destroy guest1
Please enter your authentication name: eal
Please enter your password: 
error: failed to get domain 'guest1'
error: Domain not found: no domain with matching name 'guest1'

+ rm -f /tmp/tmp.f7BitTvcII /tmp/tmp.jwNBpbcC3c /usr/local/eal4_testing/audit-test/tmp.YyTbrqteav
+ /bin/rm -f /var/lib/libvirt/images/guest1.img
+ /bin/rm -f /var/lib/libvirt/images/guest2.img
+ /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
+ /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource /sys/bus/pci/devices/0000:03:00.0/resource0
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
restorecon:  lstat(/sys/bus/pci/devices/0000:03:00.0/rom) failed:  No such file or directory
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
+ /bin/rm -f guest1.xml
+ ./evirsh nodedev-reattach pci_0000_03_00_0
spawn virsh nodedev-reattach pci_0000_03_00_0
Please enter your authentication name: eal
Please enter your password: 
Device pci_0000_03_00_0 re-attached

+ exit

augrok output
-------------
Argument "enabled 1\nfailure 1\npid 943\nrate_limit 0\nbacklog_lim..." isn't numeric in numeric eq (==) at /usr/local/eal4_testing/audit-test/utils/augrok line 1209.
type=VIRT_MACHINE_ID msg=audit(1623663289.381:514): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1" uuid=b88bd635-3003-4c29-b3e3-b7f3ac1d2dd2 vm-ctx=system_u:system_r:svirt_t:s0:c50,c70 img-ctx=system_u:object_r:svirt_image_t:s0:c50,c70 model=selinux exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_MACHINE_ID msg=audit(1623663289.381:515): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1" uuid=b88bd635-3003-4c29-b3e3-b7f3ac1d2dd2 vm-ctx=+107:+107 img-ctx=+107:+107 model=dac exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663290.149:516): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=disk reason=start vm="guest1" uuid=b88bd635-3003-4c29-b3e3-b7f3ac1d2dd2 old-disk="?" new-disk="/var/lib/libvirt/images/guest1.img" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663290.149:517): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=dev reason=start vm="guest1" uuid=b88bd635-3003-4c29-b3e3-b7f3ac1d2dd2 bus=pci device="0000:03:00.0" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663290.149:518): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=mem reason=start vm="guest1" uuid=b88bd635-3003-4c29-b3e3-b7f3ac1d2dd2 old-mem=0 new-mem=262144 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663290.149:519): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=vcpu reason=start vm="guest1" uuid=b88bd635-3003-4c29-b3e3-b7f3ac1d2dd2 old-vcpu=0 new-vcpu=1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_CONTROL msg=audit(1623663290.149:520): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm op=start reason=booted vm="guest1" uuid=b88bd635-3003-4c29-b3e3-b7f3ac1d2dd2 vm-pid=-1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=failed'
--- end output -------------------------------------------------------------


Testcase                                                                                                                                                            Result
--------                                                                                                                                                            ------
[6] pci_passthrough shared_attach_on_boot                                                                                                                            FAIL 
        Failed to start with assigned PCI
--- begin output -----------------------------------------------------------
rotate_audit_logs: Attempting to rotate using USR1
+ source testcase.bash
++ source functions.bash
+++ [[ -z '' ]]
+++ _FUNCTIONS_BASH=1
+++ shopt -s extglob
+++ unset auditd_conf audit_log
+++ auditd_conf=/etc/audit/auditd.conf
+++ audit_log=/var/log/audit/audit.log
+++ unset zero
+++ zero=test_pci_passthrough.bash
+++ [[ capp == lspp ]]
++ [[ -n '' ]]
+++ mktemp -p /usr/local/eal4_testing/audit-test
++ localtmp=/usr/local/eal4_testing/audit-test/tmp.x1XTRVbiuf
+++ mktemp
++ tmp1=/tmp/tmp.XFGM1ZeNjD
+++ mktemp
++ tmp2=/tmp/tmp.PqauilyUrq
++ trap 'test_cleanup; exit' 0 1 2 15
+ source pci_device.conf
++ pci_device=0000:03:00.0
+ source tp_luks_functions.bash
++ '[' -z ']'
+++ losetup -f
++ LOOPDEV=/dev/loop0
++ TIMEOUT=120
+ PCI_DEFCON=sysfs_t
+ scenario=shared_attach_on_boot
+ pkg_list='qemu-kvm libvirt libvirt-client'
+ pkg_list=bash
++ lspci -vvv -s 0000:03:00.0
++ sed -ne 's/Region.*Memory at \([a-f0-9]\{8\}\) .*/-e \1/p'
+ pci_regions='	-e f8000000'
+ [[ 0000:03:00.0 == *X* ]]
++ echo 0000:03:00.0
++ tr :. _
+ pci_device_name=pci_0000_03_00_0
++ echo 0000:03:00.0
++ cut -d: -f1
+ pci_domain=0000
++ echo 0000:03:00.0
++ cut -d: -f2
+ pci_bus=03
++ echo 0000:03:00.0
++ cut -d: -f3
++ sed 's/\..*//'
+ pci_slot=00
++ echo 0000:03:00.0
++ cut -d. -f2
+ pci_function=0
+ dom1=guest1
+ dom2=guest2
+ dom3=guest1-dynamic
+ dom4=guest2-dynamic
+ img_path=/var/lib/libvirt/images
++ cat /proc/sys/crypto/fips_enabled
+ FIPS=0
+ '[' x0 = x1 ']'
+ '[' -z shared_attach_on_boot ']'
+ set_selinux_booleans
+ /usr/sbin/getsebool virt_use_sysfs
+ grep off
Error getting active value for virt_use_sysfs
+ /usr/sbin/setsebool virt_use_sysfs 1
Could not change active booleans: Invalid boolean
+ reload_kvm_module_for_unsafe_interrupts
+ ./evirsh --readonly list
+ grep running
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
+ /sbin/modprobe -r kvm_intel
+ /sbin/modprobe -r kvm
+ /sbin/modprobe kvm allow_unsafe_assigned_interrupts=1
modprobe: ERROR: could not insert 'kvm': Unknown symbol in module, or unknown parameter (see dmesg)
+ /sbin/modprobe kvm_intel
+ check_kernel_boot_cmdline
+ /bin/grep intel_iommu=on /proc/cmdline
BOOT_IMAGE=/rhvh-4.3.10.1-0.20200513.0+1/vmlinuz-3.10.0-1127.8.2.el7.x86_64 root=/dev/rhvh/rhvh-4.3.10.1-0.20200513.0+1 ro crashkernel=auto rd.lvm.lv=rhvh/swap rhgb quiet intel_iommu=on rd.lvm.lv=rhvh/rhvh-4.3.10.1-0.20200513.0+1 img.bootid=rhvh-4.3.10.1-0.20200513.0+1
+ return 0
+ check_enabled_iommu
+ /bin/dmesg
+ /bin/grep 'IOMMU.*enabled'
[    0.000000] DMAR: IOMMU enabled
+ return 0
+ check_virt_extensions
+ /bin/grep vmx /proc/cpuinfo
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
+ return 0
+ check_selinux_booleans
+ return 0
+ check_kvm_modules
+ /sbin/lsmod
+ /bin/grep kvm_intel
kvm_intel             188688  0 
kvm                   636965  1 kvm_intel
+ return 0
+ check_installed_packages bash
+ /bin/rpm -q bash
bash-4.2.46-34.el7.x86_64
+ return 0
+ prepare_guest_domains
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00181913 s, 576 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00176602 s, 594 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00179695 s, 584 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.0018433 s, 569 MB/s
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c50,c70 /var/lib/libvirt/images/guest1.img
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c19,c83 /var/lib/libvirt/images/guest2.img
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp"
	/bin/rm -f /var/lib/libvirt/images/guest1.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img
	/bin/rm -f /var/lib/libvirt/images/guest2.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img
	/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
	/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
    }'
+ generate_pci_dev_file
+ /bin/cat
+ detach_multifunction_devices
++ echo pci_0000:03:00.0
++ tr :. _
+ pcifunction=pci_0000_03_00_0
++ echo pci_0000_03_00_0
++ sed 's/_[0-9]\+$//g'
+ pcidevice=pci_0000_03_00
++ ./evirsh nodedev-list
++ grep -c pci_0000_03_00
+ '[' 1 -gt 1 ']'
+ sestatus
+ grep mls
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
    }'
++ type -t test_shared_attach_on_boot
+ '[' function == function ']'
+ test_shared_attach_on_boot
+ relabel_pci_device_files_for_domain guest1
+ sestatus
+ grep mls
+ return 0
+ start_guest_with_pci_device guest1
+ local rc=0
+ create_guest_domain guest1 pci_dev.xml
+ '[' '!' -z pci_dev.xml ']'
+ /bin/sed '/HOSTDEV_CONFIG/ {r pci_dev.xml
        d}' guest1-template.xml
+ append_cleanup '/bin/rm -f guest1.xml'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
	/bin/rm -f guest1.xml
    }'
+ prepend_cleanup './evirsh destroy guest1'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	./evirsh destroy guest1
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1.xml
    }'
+ append_cleanup './evirsh nodedev-reattach pci_0000_03_00_0'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    ./evirsh destroy guest1;
    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1.xml
	./evirsh nodedev-reattach pci_0000_03_00_0
    }'
+ ./evirsh create guest1.xml
spawn virsh create guest1.xml
Please enter your authentication name: eal
Please enter your password: 
error: Failed to create domain from guest1.xml
error: unsupported configuration: host doesn't support passthrough of host PCI devices

+ return 0
+ check_device_driver pci-stub
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 == x ']'
++ basename ../../../../../bus/pci/drivers/bnx2
+ test bnx2 == pci-stub
+ return 1
+ (( rc+=2 ))
++ get_guest_domain_pid guest1
++ ./evirsh --readonly list
++ grep guest1
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
++ return
+ pid_maps=
+ check_proc_pid_maps
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 = x ']'
+ grep -e f8000000 /proc//maps
grep: /proc//maps: No such file or directory
+ return 2
+ (( rc+=4 ))
+ return 6
+ exit_fail 'Failed to start with assigned PCI'
+ [[ -n Failed to start with assigned PCI ]]
+ printf '\nexit_fail: %s\n' 'Failed to start with assigned PCI'

exit_fail: Failed to start with assigned PCI
+ exit 1
+ test_cleanup
+ ./evirsh destroy guest1
spawn virsh destroy guest1
Please enter your authentication name: eal
Please enter your password: 
error: failed to get domain 'guest1'
error: Domain not found: no domain with matching name 'guest1'

+ rm -f /tmp/tmp.XFGM1ZeNjD /tmp/tmp.PqauilyUrq /usr/local/eal4_testing/audit-test/tmp.x1XTRVbiuf
+ /bin/rm -f /var/lib/libvirt/images/guest1.img
+ /bin/rm -f /var/lib/libvirt/images/guest2.img
+ /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
+ /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource /sys/bus/pci/devices/0000:03:00.0/resource0
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
restorecon:  lstat(/sys/bus/pci/devices/0000:03:00.0/rom) failed:  No such file or directory
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
+ /bin/rm -f guest1.xml
+ ./evirsh nodedev-reattach pci_0000_03_00_0
spawn virsh nodedev-reattach pci_0000_03_00_0
Please enter your authentication name: eal
Please enter your password: 
Device pci_0000_03_00_0 re-attached

+ exit

augrok output
-------------
Argument "enabled 1\nfailure 1\npid 943\nrate_limit 0\nbacklog_lim..." isn't numeric in numeric eq (==) at /usr/local/eal4_testing/audit-test/utils/augrok line 1209.
type=VIRT_MACHINE_ID msg=audit(1623663292.306:521): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1" uuid=24062cf9-654c-43c6-a8f5-05b68f21137d vm-ctx=system_u:system_r:svirt_t:s0:c50,c70 img-ctx=system_u:object_r:svirt_image_t:s0:c50,c70 model=selinux exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_MACHINE_ID msg=audit(1623663292.306:522): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1" uuid=24062cf9-654c-43c6-a8f5-05b68f21137d vm-ctx=+107:+107 img-ctx=+107:+107 model=dac exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663293.073:523): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=disk reason=start vm="guest1" uuid=24062cf9-654c-43c6-a8f5-05b68f21137d old-disk="?" new-disk="/var/lib/libvirt/images/guest1.img" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663293.073:524): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=dev reason=start vm="guest1" uuid=24062cf9-654c-43c6-a8f5-05b68f21137d bus=pci device="0000:03:00.0" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663293.073:525): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=mem reason=start vm="guest1" uuid=24062cf9-654c-43c6-a8f5-05b68f21137d old-mem=0 new-mem=262144 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663293.073:526): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=vcpu reason=start vm="guest1" uuid=24062cf9-654c-43c6-a8f5-05b68f21137d old-vcpu=0 new-vcpu=1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_CONTROL msg=audit(1623663293.073:527): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm op=start reason=booted vm="guest1" uuid=24062cf9-654c-43c6-a8f5-05b68f21137d vm-pid=-1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=failed'
--- end output -------------------------------------------------------------


Testcase                                                                                                                                                            Result
--------                                                                                                                                                            ------
[7] pci_passthrough shared_attach_used                                                                                                                               FAIL 
        Failed to start with assigned PCI
--- begin output -----------------------------------------------------------
rotate_audit_logs: Attempting to rotate using USR1
+ source testcase.bash
++ source functions.bash
+++ [[ -z '' ]]
+++ _FUNCTIONS_BASH=1
+++ shopt -s extglob
+++ unset auditd_conf audit_log
+++ auditd_conf=/etc/audit/auditd.conf
+++ audit_log=/var/log/audit/audit.log
+++ unset zero
+++ zero=test_pci_passthrough.bash
+++ [[ capp == lspp ]]
++ [[ -n '' ]]
+++ mktemp -p /usr/local/eal4_testing/audit-test
++ localtmp=/usr/local/eal4_testing/audit-test/tmp.lXOahb11mL
+++ mktemp
++ tmp1=/tmp/tmp.GCwo3byodD
+++ mktemp
++ tmp2=/tmp/tmp.gB3NeW8dct
++ trap 'test_cleanup; exit' 0 1 2 15
+ source pci_device.conf
++ pci_device=0000:03:00.0
+ source tp_luks_functions.bash
++ '[' -z ']'
+++ losetup -f
++ LOOPDEV=/dev/loop0
++ TIMEOUT=120
+ PCI_DEFCON=sysfs_t
+ scenario=shared_attach_used
+ pkg_list='qemu-kvm libvirt libvirt-client'
+ pkg_list=bash
++ lspci -vvv -s 0000:03:00.0
++ sed -ne 's/Region.*Memory at \([a-f0-9]\{8\}\) .*/-e \1/p'
+ pci_regions='	-e f8000000'
+ [[ 0000:03:00.0 == *X* ]]
++ echo 0000:03:00.0
++ tr :. _
+ pci_device_name=pci_0000_03_00_0
++ echo 0000:03:00.0
++ cut -d: -f1
+ pci_domain=0000
++ echo 0000:03:00.0
++ cut -d: -f2
+ pci_bus=03
++ echo 0000:03:00.0
++ cut -d: -f3
++ sed 's/\..*//'
+ pci_slot=00
++ echo 0000:03:00.0
++ cut -d. -f2
+ pci_function=0
+ dom1=guest1
+ dom2=guest2
+ dom3=guest1-dynamic
+ dom4=guest2-dynamic
+ img_path=/var/lib/libvirt/images
++ cat /proc/sys/crypto/fips_enabled
+ FIPS=0
+ '[' x0 = x1 ']'
+ '[' -z shared_attach_used ']'
+ set_selinux_booleans
+ /usr/sbin/getsebool virt_use_sysfs
+ grep off
Error getting active value for virt_use_sysfs
+ /usr/sbin/setsebool virt_use_sysfs 1
Could not change active booleans: Invalid boolean
+ reload_kvm_module_for_unsafe_interrupts
+ ./evirsh --readonly list
+ grep running
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
+ /sbin/modprobe -r kvm_intel
+ /sbin/modprobe -r kvm
+ /sbin/modprobe kvm allow_unsafe_assigned_interrupts=1
modprobe: ERROR: could not insert 'kvm': Unknown symbol in module, or unknown parameter (see dmesg)
+ /sbin/modprobe kvm_intel
+ check_kernel_boot_cmdline
+ /bin/grep intel_iommu=on /proc/cmdline
BOOT_IMAGE=/rhvh-4.3.10.1-0.20200513.0+1/vmlinuz-3.10.0-1127.8.2.el7.x86_64 root=/dev/rhvh/rhvh-4.3.10.1-0.20200513.0+1 ro crashkernel=auto rd.lvm.lv=rhvh/swap rhgb quiet intel_iommu=on rd.lvm.lv=rhvh/rhvh-4.3.10.1-0.20200513.0+1 img.bootid=rhvh-4.3.10.1-0.20200513.0+1
+ return 0
+ check_enabled_iommu
+ /bin/dmesg
+ /bin/grep 'IOMMU.*enabled'
[    0.000000] DMAR: IOMMU enabled
+ return 0
+ check_virt_extensions
+ /bin/grep vmx /proc/cpuinfo
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
+ return 0
+ check_selinux_booleans
+ return 0
+ check_kvm_modules
+ /sbin/lsmod
+ /bin/grep kvm_intel
kvm_intel             188688  0 
kvm                   636965  1 kvm_intel
+ return 0
+ check_installed_packages bash
+ /bin/rpm -q bash
bash-4.2.46-34.el7.x86_64
+ return 0
+ prepare_guest_domains
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00191829 s, 547 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00177194 s, 592 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00200687 s, 522 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00190708 s, 550 MB/s
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c50,c70 /var/lib/libvirt/images/guest1.img
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c19,c83 /var/lib/libvirt/images/guest2.img
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp"
	/bin/rm -f /var/lib/libvirt/images/guest1.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img
	/bin/rm -f /var/lib/libvirt/images/guest2.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img
	/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
	/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
    }'
+ generate_pci_dev_file
+ /bin/cat
+ detach_multifunction_devices
++ echo pci_0000:03:00.0
++ tr :. _
+ pcifunction=pci_0000_03_00_0
++ echo pci_0000_03_00_0
++ sed 's/_[0-9]\+$//g'
+ pcidevice=pci_0000_03_00
++ ./evirsh nodedev-list
++ grep -c pci_0000_03_00
+ '[' 1 -gt 1 ']'
+ sestatus
+ grep mls
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
    }'
++ type -t test_shared_attach_used
+ '[' function == function ']'
+ test_shared_attach_used
+ relabel_pci_device_files_for_domain guest1
+ sestatus
+ grep mls
+ return 0
+ start_guest_with_pci_device guest1
+ local rc=0
+ create_guest_domain guest1 pci_dev.xml
+ '[' '!' -z pci_dev.xml ']'
+ /bin/sed '/HOSTDEV_CONFIG/ {r pci_dev.xml
        d}' guest1-template.xml
+ append_cleanup '/bin/rm -f guest1.xml'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
	/bin/rm -f guest1.xml
    }'
+ prepend_cleanup './evirsh destroy guest1'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	./evirsh destroy guest1
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1.xml
    }'
+ append_cleanup './evirsh nodedev-reattach pci_0000_03_00_0'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    ./evirsh destroy guest1;
    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1.xml
	./evirsh nodedev-reattach pci_0000_03_00_0
    }'
+ ./evirsh create guest1.xml
spawn virsh create guest1.xml
Please enter your authentication name: eal
Please enter your password: 
error: Failed to create domain from guest1.xml
error: unsupported configuration: host doesn't support passthrough of host PCI devices

+ return 0
+ check_device_driver pci-stub
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 == x ']'
++ basename ../../../../../bus/pci/drivers/bnx2
+ test bnx2 == pci-stub
+ return 1
+ (( rc+=2 ))
++ get_guest_domain_pid guest1
++ ./evirsh --readonly list
++ grep guest1
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
++ return
+ pid_maps=
+ check_proc_pid_maps
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 = x ']'
+ grep -e f8000000 /proc//maps
grep: /proc//maps: No such file or directory
+ return 2
+ (( rc+=4 ))
+ return 6
+ exit_fail 'Failed to start with assigned PCI'
+ [[ -n Failed to start with assigned PCI ]]
+ printf '\nexit_fail: %s\n' 'Failed to start with assigned PCI'

exit_fail: Failed to start with assigned PCI
+ exit 1
+ test_cleanup
+ ./evirsh destroy guest1
spawn virsh destroy guest1
Please enter your authentication name: eal
Please enter your password: 
error: failed to get domain 'guest1'
error: Domain not found: no domain with matching name 'guest1'

+ rm -f /tmp/tmp.GCwo3byodD /tmp/tmp.gB3NeW8dct /usr/local/eal4_testing/audit-test/tmp.lXOahb11mL
+ /bin/rm -f /var/lib/libvirt/images/guest1.img
+ /bin/rm -f /var/lib/libvirt/images/guest2.img
+ /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
+ /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource /sys/bus/pci/devices/0000:03:00.0/resource0
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
restorecon:  lstat(/sys/bus/pci/devices/0000:03:00.0/rom) failed:  No such file or directory
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
+ /bin/rm -f guest1.xml
+ ./evirsh nodedev-reattach pci_0000_03_00_0
spawn virsh nodedev-reattach pci_0000_03_00_0
Please enter your authentication name: eal
Please enter your password: 
Device pci_0000_03_00_0 re-attached

+ exit

augrok output
-------------
Argument "enabled 1\nfailure 1\npid 943\nrate_limit 0\nbacklog_lim..." isn't numeric in numeric eq (==) at /usr/local/eal4_testing/audit-test/utils/augrok line 1209.
type=VIRT_MACHINE_ID msg=audit(1623663295.218:528): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1" uuid=61637d28-e9a8-4109-ab38-a48ee2705634 vm-ctx=system_u:system_r:svirt_t:s0:c50,c70 img-ctx=system_u:object_r:svirt_image_t:s0:c50,c70 model=selinux exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_MACHINE_ID msg=audit(1623663295.218:529): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1" uuid=61637d28-e9a8-4109-ab38-a48ee2705634 vm-ctx=+107:+107 img-ctx=+107:+107 model=dac exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663295.985:530): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=disk reason=start vm="guest1" uuid=61637d28-e9a8-4109-ab38-a48ee2705634 old-disk="?" new-disk="/var/lib/libvirt/images/guest1.img" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663295.985:531): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=dev reason=start vm="guest1" uuid=61637d28-e9a8-4109-ab38-a48ee2705634 bus=pci device="0000:03:00.0" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663295.985:532): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=mem reason=start vm="guest1" uuid=61637d28-e9a8-4109-ab38-a48ee2705634 old-mem=0 new-mem=262144 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663295.985:533): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=vcpu reason=start vm="guest1" uuid=61637d28-e9a8-4109-ab38-a48ee2705634 old-vcpu=0 new-vcpu=1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_CONTROL msg=audit(1623663295.985:534): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm op=start reason=booted vm="guest1" uuid=61637d28-e9a8-4109-ab38-a48ee2705634 vm-pid=-1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=failed'
--- end output -------------------------------------------------------------


Testcase                                                                                                                                                            Result
--------                                                                                                                                                            ------
[8] pci_passthrough shared_detach_used                                                                                                                               FAIL 
        Failed to start with assigned PCI
--- begin output -----------------------------------------------------------
rotate_audit_logs: Attempting to rotate using USR1
+ source testcase.bash
++ source functions.bash
+++ [[ -z '' ]]
+++ _FUNCTIONS_BASH=1
+++ shopt -s extglob
+++ unset auditd_conf audit_log
+++ auditd_conf=/etc/audit/auditd.conf
+++ audit_log=/var/log/audit/audit.log
+++ unset zero
+++ zero=test_pci_passthrough.bash
+++ [[ capp == lspp ]]
++ [[ -n '' ]]
+++ mktemp -p /usr/local/eal4_testing/audit-test
++ localtmp=/usr/local/eal4_testing/audit-test/tmp.ZIG8Y4VmIw
+++ mktemp
++ tmp1=/tmp/tmp.G21WmJB4rI
+++ mktemp
++ tmp2=/tmp/tmp.uiL23Rz12S
++ trap 'test_cleanup; exit' 0 1 2 15
+ source pci_device.conf
++ pci_device=0000:03:00.0
+ source tp_luks_functions.bash
++ '[' -z ']'
+++ losetup -f
++ LOOPDEV=/dev/loop0
++ TIMEOUT=120
+ PCI_DEFCON=sysfs_t
+ scenario=shared_detach_used
+ pkg_list='qemu-kvm libvirt libvirt-client'
+ pkg_list=bash
++ lspci -vvv -s 0000:03:00.0
++ sed -ne 's/Region.*Memory at \([a-f0-9]\{8\}\) .*/-e \1/p'
+ pci_regions='	-e f8000000'
+ [[ 0000:03:00.0 == *X* ]]
++ echo 0000:03:00.0
++ tr :. _
+ pci_device_name=pci_0000_03_00_0
++ echo 0000:03:00.0
++ cut -d: -f1
+ pci_domain=0000
++ echo 0000:03:00.0
++ cut -d: -f2
+ pci_bus=03
++ echo 0000:03:00.0
++ cut -d: -f3
++ sed 's/\..*//'
+ pci_slot=00
++ echo 0000:03:00.0
++ cut -d. -f2
+ pci_function=0
+ dom1=guest1
+ dom2=guest2
+ dom3=guest1-dynamic
+ dom4=guest2-dynamic
+ img_path=/var/lib/libvirt/images
++ cat /proc/sys/crypto/fips_enabled
+ FIPS=0
+ '[' x0 = x1 ']'
+ '[' -z shared_detach_used ']'
+ set_selinux_booleans
+ /usr/sbin/getsebool virt_use_sysfs
+ grep off
Error getting active value for virt_use_sysfs
+ /usr/sbin/setsebool virt_use_sysfs 1
Could not change active booleans: Invalid boolean
+ reload_kvm_module_for_unsafe_interrupts
+ ./evirsh --readonly list
+ grep running
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
+ /sbin/modprobe -r kvm_intel
+ /sbin/modprobe -r kvm
+ /sbin/modprobe kvm allow_unsafe_assigned_interrupts=1
modprobe: ERROR: could not insert 'kvm': Unknown symbol in module, or unknown parameter (see dmesg)
+ /sbin/modprobe kvm_intel
+ check_kernel_boot_cmdline
+ /bin/grep intel_iommu=on /proc/cmdline
BOOT_IMAGE=/rhvh-4.3.10.1-0.20200513.0+1/vmlinuz-3.10.0-1127.8.2.el7.x86_64 root=/dev/rhvh/rhvh-4.3.10.1-0.20200513.0+1 ro crashkernel=auto rd.lvm.lv=rhvh/swap rhgb quiet intel_iommu=on rd.lvm.lv=rhvh/rhvh-4.3.10.1-0.20200513.0+1 img.bootid=rhvh-4.3.10.1-0.20200513.0+1
+ return 0
+ check_enabled_iommu
+ /bin/dmesg
+ /bin/grep 'IOMMU.*enabled'
[    0.000000] DMAR: IOMMU enabled
+ return 0
+ check_virt_extensions
+ /bin/grep vmx /proc/cpuinfo
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
+ return 0
+ check_selinux_booleans
+ return 0
+ check_kvm_modules
+ /sbin/lsmod
+ /bin/grep kvm_intel
kvm_intel             188688  0 
kvm                   636965  1 kvm_intel
+ return 0
+ check_installed_packages bash
+ /bin/rpm -q bash
bash-4.2.46-34.el7.x86_64
+ return 0
+ prepare_guest_domains
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00183005 s, 573 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00178477 s, 588 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00196872 s, 533 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00187992 s, 558 MB/s
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c50,c70 /var/lib/libvirt/images/guest1.img
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c19,c83 /var/lib/libvirt/images/guest2.img
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp"
	/bin/rm -f /var/lib/libvirt/images/guest1.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img
	/bin/rm -f /var/lib/libvirt/images/guest2.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img
	/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
	/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
    }'
+ generate_pci_dev_file
+ /bin/cat
+ detach_multifunction_devices
++ echo pci_0000:03:00.0
++ tr :. _
+ pcifunction=pci_0000_03_00_0
++ echo pci_0000_03_00_0
++ sed 's/_[0-9]\+$//g'
+ pcidevice=pci_0000_03_00
++ ./evirsh nodedev-list
++ grep -c pci_0000_03_00
+ '[' 1 -gt 1 ']'
+ sestatus
+ grep mls
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
    }'
++ type -t test_shared_detach_used
+ '[' function == function ']'
+ test_shared_detach_used
+ relabel_pci_device_files_for_domain guest1
+ sestatus
+ grep mls
+ return 0
+ start_guest_with_pci_device guest1
+ local rc=0
+ create_guest_domain guest1 pci_dev.xml
+ '[' '!' -z pci_dev.xml ']'
+ /bin/sed '/HOSTDEV_CONFIG/ {r pci_dev.xml
        d}' guest1-template.xml
+ append_cleanup '/bin/rm -f guest1.xml'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
	/bin/rm -f guest1.xml
    }'
+ prepend_cleanup './evirsh destroy guest1'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	./evirsh destroy guest1
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1.xml
    }'
+ append_cleanup './evirsh nodedev-reattach pci_0000_03_00_0'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    ./evirsh destroy guest1;
    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1.xml
	./evirsh nodedev-reattach pci_0000_03_00_0
    }'
+ ./evirsh create guest1.xml
spawn virsh create guest1.xml
Please enter your authentication name: eal
Please enter your password: 
error: Failed to create domain from guest1.xml
error: unsupported configuration: host doesn't support passthrough of host PCI devices

+ return 0
+ check_device_driver pci-stub
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 == x ']'
++ basename ../../../../../bus/pci/drivers/bnx2
+ test bnx2 == pci-stub
+ return 1
+ (( rc+=2 ))
++ get_guest_domain_pid guest1
++ ./evirsh --readonly list
++ grep guest1
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
++ return
+ pid_maps=
+ check_proc_pid_maps
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 = x ']'
+ grep -e f8000000 /proc//maps
grep: /proc//maps: No such file or directory
+ return 2
+ (( rc+=4 ))
+ return 6
+ exit_fail 'Failed to start with assigned PCI'
+ [[ -n Failed to start with assigned PCI ]]
+ printf '\nexit_fail: %s\n' 'Failed to start with assigned PCI'

exit_fail: Failed to start with assigned PCI
+ exit 1
+ test_cleanup
+ ./evirsh destroy guest1
spawn virsh destroy guest1
Please enter your authentication name: eal
Please enter your password: 
error: failed to get domain 'guest1'
error: Domain not found: no domain with matching name 'guest1'

+ rm -f /tmp/tmp.G21WmJB4rI /tmp/tmp.uiL23Rz12S /usr/local/eal4_testing/audit-test/tmp.ZIG8Y4VmIw
+ /bin/rm -f /var/lib/libvirt/images/guest1.img
+ /bin/rm -f /var/lib/libvirt/images/guest2.img
+ /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
+ /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource /sys/bus/pci/devices/0000:03:00.0/resource0
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
restorecon:  lstat(/sys/bus/pci/devices/0000:03:00.0/rom) failed:  No such file or directory
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
+ /bin/rm -f guest1.xml
+ ./evirsh nodedev-reattach pci_0000_03_00_0
spawn virsh nodedev-reattach pci_0000_03_00_0
Please enter your authentication name: eal
Please enter your password: 
Device pci_0000_03_00_0 re-attached

+ exit

augrok output
-------------
Argument "enabled 1\nfailure 1\npid 943\nrate_limit 0\nbacklog_lim..." isn't numeric in numeric eq (==) at /usr/local/eal4_testing/audit-test/utils/augrok line 1209.
type=VIRT_MACHINE_ID msg=audit(1623663298.133:535): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1" uuid=2b17e192-0aa5-4b8b-a1ce-0ef5b0e6f90b vm-ctx=system_u:system_r:svirt_t:s0:c50,c70 img-ctx=system_u:object_r:svirt_image_t:s0:c50,c70 model=selinux exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_MACHINE_ID msg=audit(1623663298.133:536): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1" uuid=2b17e192-0aa5-4b8b-a1ce-0ef5b0e6f90b vm-ctx=+107:+107 img-ctx=+107:+107 model=dac exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663298.897:537): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=disk reason=start vm="guest1" uuid=2b17e192-0aa5-4b8b-a1ce-0ef5b0e6f90b old-disk="?" new-disk="/var/lib/libvirt/images/guest1.img" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663298.897:538): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=dev reason=start vm="guest1" uuid=2b17e192-0aa5-4b8b-a1ce-0ef5b0e6f90b bus=pci device="0000:03:00.0" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663298.898:539): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=mem reason=start vm="guest1" uuid=2b17e192-0aa5-4b8b-a1ce-0ef5b0e6f90b old-mem=0 new-mem=262144 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663298.898:540): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=vcpu reason=start vm="guest1" uuid=2b17e192-0aa5-4b8b-a1ce-0ef5b0e6f90b old-vcpu=0 new-vcpu=1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_CONTROL msg=audit(1623663298.898:541): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm op=start reason=booted vm="guest1" uuid=2b17e192-0aa5-4b8b-a1ce-0ef5b0e6f90b vm-pid=-1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=failed'
--- end output -------------------------------------------------------------


Testcase                                                                                                                                                            Result
--------                                                                                                                                                            ------
[9] pci_passthrough dynamic_attach_on_boot                                                                                                                           FAIL 
        Failed to start guest with assigned PCI
--- begin output -----------------------------------------------------------
rotate_audit_logs: Attempting to rotate using USR1
+ source testcase.bash
++ source functions.bash
+++ [[ -z '' ]]
+++ _FUNCTIONS_BASH=1
+++ shopt -s extglob
+++ unset auditd_conf audit_log
+++ auditd_conf=/etc/audit/auditd.conf
+++ audit_log=/var/log/audit/audit.log
+++ unset zero
+++ zero=test_pci_passthrough.bash
+++ [[ capp == lspp ]]
++ [[ -n '' ]]
+++ mktemp -p /usr/local/eal4_testing/audit-test
++ localtmp=/usr/local/eal4_testing/audit-test/tmp.mzs28xfMbC
+++ mktemp
++ tmp1=/tmp/tmp.GRgikky0At
+++ mktemp
++ tmp2=/tmp/tmp.mkCZYkgVmp
++ trap 'test_cleanup; exit' 0 1 2 15
+ source pci_device.conf
++ pci_device=0000:03:00.0
+ source tp_luks_functions.bash
++ '[' -z ']'
+++ losetup -f
++ LOOPDEV=/dev/loop0
++ TIMEOUT=120
+ PCI_DEFCON=sysfs_t
+ scenario=dynamic_attach_on_boot
+ pkg_list='qemu-kvm libvirt libvirt-client'
+ pkg_list=bash
++ lspci -vvv -s 0000:03:00.0
++ sed -ne 's/Region.*Memory at \([a-f0-9]\{8\}\) .*/-e \1/p'
+ pci_regions='	-e f8000000'
+ [[ 0000:03:00.0 == *X* ]]
++ echo 0000:03:00.0
++ tr :. _
+ pci_device_name=pci_0000_03_00_0
++ echo 0000:03:00.0
++ cut -d: -f1
+ pci_domain=0000
++ echo 0000:03:00.0
++ cut -d: -f2
+ pci_bus=03
++ echo 0000:03:00.0
++ cut -d: -f3
++ sed 's/\..*//'
+ pci_slot=00
++ echo 0000:03:00.0
++ cut -d. -f2
+ pci_function=0
+ dom1=guest1
+ dom2=guest2
+ dom3=guest1-dynamic
+ dom4=guest2-dynamic
+ img_path=/var/lib/libvirt/images
++ cat /proc/sys/crypto/fips_enabled
+ FIPS=0
+ '[' x0 = x1 ']'
+ '[' -z dynamic_attach_on_boot ']'
+ set_selinux_booleans
+ /usr/sbin/getsebool virt_use_sysfs
+ grep off
Error getting active value for virt_use_sysfs
+ /usr/sbin/setsebool virt_use_sysfs 1
Could not change active booleans: Invalid boolean
+ reload_kvm_module_for_unsafe_interrupts
+ ./evirsh --readonly list
+ grep running
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
+ /sbin/modprobe -r kvm_intel
+ /sbin/modprobe -r kvm
+ /sbin/modprobe kvm allow_unsafe_assigned_interrupts=1
modprobe: ERROR: could not insert 'kvm': Unknown symbol in module, or unknown parameter (see dmesg)
+ /sbin/modprobe kvm_intel
+ check_kernel_boot_cmdline
+ /bin/grep intel_iommu=on /proc/cmdline
BOOT_IMAGE=/rhvh-4.3.10.1-0.20200513.0+1/vmlinuz-3.10.0-1127.8.2.el7.x86_64 root=/dev/rhvh/rhvh-4.3.10.1-0.20200513.0+1 ro crashkernel=auto rd.lvm.lv=rhvh/swap rhgb quiet intel_iommu=on rd.lvm.lv=rhvh/rhvh-4.3.10.1-0.20200513.0+1 img.bootid=rhvh-4.3.10.1-0.20200513.0+1
+ return 0
+ check_enabled_iommu
+ /bin/dmesg
+ /bin/grep 'IOMMU.*enabled'
[    0.000000] DMAR: IOMMU enabled
+ return 0
+ check_virt_extensions
+ /bin/grep vmx /proc/cpuinfo
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl aperfmperf eagerfpu pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 xsave lahf_lm tpr_shadow vnmi flexpriority dtherm
+ return 0
+ check_selinux_booleans
+ return 0
+ check_kvm_modules
+ /sbin/lsmod
+ /bin/grep kvm_intel
kvm_intel             188688  0 
kvm                   636965  1 kvm_intel
+ return 0
+ check_installed_packages bash
+ /bin/rpm -q bash
bash-4.2.46-34.el7.x86_64
+ return 0
+ prepare_guest_domains
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00182132 s, 576 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00177427 s, 591 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest1-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.00178549 s, 587 MB/s
+ /bin/dd if=/dev/zero of=/var/lib/libvirt/images/guest2-dynamic.img bs=1M count=1
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.0019904 s, 527 MB/s
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c50,c70 /var/lib/libvirt/images/guest1.img
+ /usr/bin/chcon system_u:object_r:svirt_image_t:s0:c19,c83 /var/lib/libvirt/images/guest2.img
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp"
	/bin/rm -f /var/lib/libvirt/images/guest1.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img
	/bin/rm -f /var/lib/libvirt/images/guest2.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img
	/bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
    }'
+ append_cleanup '/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
	/bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
    }'
+ generate_pci_dev_file
+ /bin/cat
+ detach_multifunction_devices
++ echo pci_0000:03:00.0
++ tr :. _
+ pcifunction=pci_0000_03_00_0
++ echo pci_0000_03_00_0
++ sed 's/_[0-9]\+$//g'
+ pcidevice=pci_0000_03_00
++ ./evirsh nodedev-list
++ grep -c pci_0000_03_00
+ '[' 1 -gt 1 ']'
+ sestatus
+ grep mls
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
    }'
+ append_cleanup 'restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
	restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
    }'
++ type -t test_dynamic_attach_on_boot
+ '[' function == function ']'
+ test_dynamic_attach_on_boot
+ start_guest_with_pci_device guest1-dynamic
+ local rc=0
+ create_guest_domain guest1-dynamic pci_dev.xml
+ '[' '!' -z pci_dev.xml ']'
+ /bin/sed '/HOSTDEV_CONFIG/ {r pci_dev.xml
        d}' guest1-dynamic-template.xml
+ append_cleanup '/bin/rm -f guest1-dynamic.xml'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
	/bin/rm -f guest1-dynamic.xml
    }'
+ prepend_cleanup './evirsh destroy guest1-dynamic'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	./evirsh destroy guest1-dynamic
	    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1-dynamic.xml
    }'
+ append_cleanup './evirsh nodedev-reattach pci_0000_03_00_0'
++ type test_cleanup
++ sed '1,3d;$d'
+ eval 'function test_cleanup {
	    ./evirsh destroy guest1-dynamic;
    rm -f "$tmp1" "$tmp2" "$localtmp";
    /bin/rm -f /var/lib/libvirt/images/guest1.img;
    /bin/rm -f /var/lib/libvirt/images/guest2.img;
    /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img;
    /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource*;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom;
    restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset;
    /bin/rm -f guest1-dynamic.xml
	./evirsh nodedev-reattach pci_0000_03_00_0
    }'
+ ./evirsh create guest1-dynamic.xml
spawn virsh create guest1-dynamic.xml
Please enter your authentication name: eal
Please enter your password: 
error: Failed to create domain from guest1-dynamic.xml
error: unsupported configuration: host doesn't support passthrough of host PCI devices

+ return 0
+ check_device_driver pci-stub
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 == x ']'
++ basename ../../../../../bus/pci/drivers/bnx2
+ test bnx2 == pci-stub
+ return 1
+ (( rc+=2 ))
++ get_guest_domain_pid guest1-dynamic
++ ./evirsh --readonly list
++ grep guest1-dynamic
expect: spawn id exp4 not open
    while executing
"expect "password:" { send "Ooxee6ee\n" }"
    (file "./evirsh" line 5)
++ return
+ pid_maps=
+ check_proc_pid_maps
++ readlink /sys/bus/pci/devices/0000:03:00.0/driver
+ driver=../../../../../bus/pci/drivers/bnx2
+ '[' x../../../../../bus/pci/drivers/bnx2 = x ']'
+ grep -e f8000000 /proc//maps
grep: /proc//maps: No such file or directory
+ return 2
+ (( rc+=4 ))
+ return 6
+ exit_fail 'Failed to start guest with assigned PCI'
+ [[ -n Failed to start guest with assigned PCI ]]
+ printf '\nexit_fail: %s\n' 'Failed to start guest with assigned PCI'

exit_fail: Failed to start guest with assigned PCI
+ exit 1
+ test_cleanup
+ ./evirsh destroy guest1-dynamic
spawn virsh destroy guest1-dynamic
Please enter your authentication name: eal
Please enter your password: 
error: failed to get domain 'guest1-dynamic'
error: Domain not found: no domain with matching name 'guest1-dynamic'

+ rm -f /tmp/tmp.GRgikky0At /tmp/tmp.mkCZYkgVmp /usr/local/eal4_testing/audit-test/tmp.mzs28xfMbC
+ /bin/rm -f /var/lib/libvirt/images/guest1.img
+ /bin/rm -f /var/lib/libvirt/images/guest2.img
+ /bin/rm -f /var/lib/libvirt/images/guest1-dynamic.img
+ /bin/rm -f /var/lib/libvirt/images/guest2-dynamic.img
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/resource /sys/bus/pci/devices/0000:03:00.0/resource0
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/rom
restorecon:  lstat(/sys/bus/pci/devices/0000:03:00.0/rom) failed:  No such file or directory
+ restorecon -RvvvF /sys/bus/pci/devices/0000:03:00.0/reset
+ /bin/rm -f guest1-dynamic.xml
+ ./evirsh nodedev-reattach pci_0000_03_00_0
spawn virsh nodedev-reattach pci_0000_03_00_0
Please enter your authentication name: eal
Please enter your password: 
Device pci_0000_03_00_0 re-attached

+ exit

augrok output
-------------
Argument "enabled 1\nfailure 1\npid 943\nrate_limit 0\nbacklog_lim..." isn't numeric in numeric eq (==) at /usr/local/eal4_testing/audit-test/utils/augrok line 1209.
type=VIRT_MACHINE_ID msg=audit(1623663301.074:542): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1-dynamic" uuid=cf1a6351-52aa-4862-8b61-4cc47aa516af vm-ctx=system_u:system_r:svirt_t:s0:c499,c756 img-ctx=system_u:object_r:svirt_image_t:s0:c499,c756 model=selinux exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_MACHINE_ID msg=audit(1623663301.074:543): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm vm="guest1-dynamic" uuid=cf1a6351-52aa-4862-8b61-4cc47aa516af vm-ctx=+107:+107 img-ctx=+107:+107 model=dac exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663301.852:544): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=disk reason=start vm="guest1-dynamic" uuid=cf1a6351-52aa-4862-8b61-4cc47aa516af old-disk="?" new-disk="/var/lib/libvirt/images/guest1-dynamic.img" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663301.852:545): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=dev reason=start vm="guest1-dynamic" uuid=cf1a6351-52aa-4862-8b61-4cc47aa516af bus=pci device="0000:03:00.0" exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663301.852:546): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=mem reason=start vm="guest1-dynamic" uuid=cf1a6351-52aa-4862-8b61-4cc47aa516af old-mem=0 new-mem=262144 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_RESOURCE msg=audit(1623663301.852:547): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm resrc=vcpu reason=start vm="guest1-dynamic" uuid=cf1a6351-52aa-4862-8b61-4cc47aa516af old-vcpu=0 new-vcpu=1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=success'
type=VIRT_CONTROL msg=audit(1623663301.852:548): pid=2035 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:virtd_t:s0-s0:c0.c1023 msg_1='virt=kvm op=start reason=booted vm="guest1-dynamic" uuid=cf1a6351-52aa-4862-8b61-4cc47aa516af vm-pid=-1 exe="/usr/sbin/libvirtd" hostname=? addr=? terminal=? res=failed'
--- end output -------------------------------------------------------------


Testcase                                                                                                                                                            Result
--------                                                                                                                                                            ------
[10] usb_passthrough dynamic_attach_on_boot                                                                                                                      ERROR (2)
        USB device 0781:5581 not found
--- begin output -----------------------------------------------------------
rotate_audit_logs: Attempting to rotate using USR1
+ source testcase.bash
++ source functions.bash
+++ [[ -z '' ]]
+++ _FUNCTIONS_BASH=1
+++ shopt -s extglob
+++ unset auditd_conf audit_log
+++ auditd_conf=/etc/audit/auditd.conf
+++ audit_log=/var/log/audit/audit.log
+++ unset zero
+++ zero=test_usb_passthrough.bash
+++ [[ capp == lspp ]]
++ [[ -n '' ]]
+++ mktemp -p /usr/local/eal4_testing/audit-test
++ localtmp=/usr/local/eal4_testing/audit-test/tmp.172GQ106O1
+++ mktemp
++ tmp1=/tmp/tmp.U5cIcMl8cn
+++ mktemp
++ tmp2=/tmp/tmp.7hVN90MKhC
++ trap 'test_cleanup; exit' 0 1 2 15
+ source usb_device.conf
++ usb_device_id=0781:5581
+ source tp_luks_functions.bash
++ '[' -z ']'
+++ losetup -f
++ LOOPDEV=/dev/loop0
++ TIMEOUT=120
+ AUDIT_LOG=/var/log/audit/audit.log
+ USB_DEFCON=usb_device_t
+ scenario=dynamic_attach_on_boot
+ pkg_list='qemu-kvm libvirt libvirt-client'
+ [[ 0781:5581 == *X* ]]
++ echo 0781:5581
++ cut -d: -f1
+ usb_vendor=0781
+ '[' x = x0781 ']'
++ echo 0781:5581
++ cut -d: -f2
+ usb_product=5581
+ '[' x = x5581 ']'
++ lsusb
++ grep -m1 0781:5581
++ tr : ' '
++ cut '-d ' -f2
+ usb_bus=
+ '[' x = x ']'
+ exit_error 'USB device 0781:5581 not found'
+ declare status
+ [[ -n USB device 0781:5581 not found ]]
+ [[ USB device 0781:5581 not found != *[!0-9]* ]]
+ status=2
+ [[ -n USB device 0781:5581 not found ]]
+ printf '\nexit_error: %s\n' 'USB device 0781:5581 not found'

exit_error: USB device 0781:5581 not found
+ exit 2
+ test_cleanup
+ rm -f /tmp/tmp.U5cIcMl8cn /tmp/tmp.7hVN90MKhC /usr/local/eal4_testing/audit-test/tmp.172GQ106O1
+ exit
--- end output -------------------------------------------------------------



   0 pass (0%)
   9 fail (81%)
   2 error (18%)
------------------
  11 total
Killing all processes for testuser
Removing user testuser
Removing group testuser
Killing all processes for testadmin
Removing user testadmin
Removing group testadmin
